<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>XXE利用和加固</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>XXE利用和加固</h1><br/><a href="https://mp.weixin.qq.com/s/GujjnOoaF0LGuM3jV_b9Dw">https://mp.weixin.qq.com/s/GujjnOoaF0LGuM3jV_b9Dw</a><br /><br /><br />一、XML基础知识<br /><a href=""><img src="images\216-1.png" alt="images\216-1.png" /></a><br />内部声明实体    &lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt;<br />引用外部实体    &lt;!ENTITY 实体名称 SYSTEM &quot;URI&quot;&gt;或者    &lt;!ENTITY 实体名称 PUBLIC &quot;public_ID&quot; &quot;URI&quot;&gt;<br /><br /><br /><br />二、XML外部实体注入(XML External Entity)<br /><span style="color:#90ee90;">XXE危害1：读取任意文件</span><br /><br />恶意引入外部实体方式1：<br /><a href=""><img src="images\216-2.png" alt="images\216-2.png" /></a><br /><br />恶意引入外部实体方式2：<br /><a href=""><img src="images\216-3.png" alt="images\216-3.png" /></a><br />或<br /><a href=""><img src="images\216-4.png" alt="images\216-4.png" /></a><br /><br />DTD文件(evil.dtd)内容：<br /><a href=""><img src="images\216-5.png" alt="images\216-5.png" /></a><br /><br /><span style="color:#90ee90;">XXE危害2：执行系统命令</span><br /><br /><a href=""><img src="images\216-6.png" alt="images\216-6.png" /></a><br /><br /><br /><br /><br /><span style="color:#90ee90;">XXE危害3：探测内网端口</span><br /><br /><a href=""><img src="images\216-7.png" alt="images\216-7.png" /></a><br /><br /><br /><span style="color:#90ee90;">XXE危害4：攻击内网网站</span><br /><br /><a href=""><img src="images\216-8.png" alt="images\216-8.png" /></a><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><span style="color:#ab1942;">四、防御XXE攻击</span><br /><br /><span style="color:#90ee90;">方案一、使用开发语言提供的禁用外部实体的方法</span><br /><br /><br />PHP：<br />libxml_disable_entity_loader(true);<br /><br />JAVA:<br />DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();<br />dbf.setExpandEntityReferences(false);<br /><br />Python：<br />from lxml import etree<br />xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))<br /> <br /><span style="color:#90ee90;">方案二、过滤用户提交的XML数据</span><br />       <br />关键词：&lt;!DOCTYPE和&lt;!ENTITY，或者，SYSTEM和PUBLIC。<br /><br /><br /><br /><br /><br /><br /><br />1. 对于PHP，常见的XML解析方法有：DOMDocument、SimpleXML、XMLReader，这三者都基于 libxml 库解析 XML，所以均受影响，xml_parse 函数则基于 expact 解析器，默认不载入外部 DTD ，不受影响。可以在php解析xml文件之前使用libxml_disable_entity_loader(true)来禁止加载外部实体（对上述三种 XML 解析组件都有效），并使用libxml_use_internal_errors()禁止报错；<br />2. 对于Java，设置DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();<br />dbf.setExpandEntityReferences(false);<br />3. 对用户的输入做过滤，如&lt;、&gt;、&#39;、&quot;、&amp;等<br /><br /><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>