<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>exe系统服务</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>exe系统服务</h1><br/>安装自定义服务：<br />sc create supconserver binpath= &quot;c:/supconserver.exe&quot; displayname= &quot;supconserver&quot; start= auto<br />服务需包括特定api函数<br />ServiceMain<br />SetServiceStatus<br />RegisterServiceCtrlHandler<br />等<br /><br /><div class="codebox"><div class="codebox">#include&quot;stdafx.h&quot;<br />#include&lt;WINDOWS.H&gt;<br />#include&lt;stdio.h&gt;<br />#pragma&nbsp;comment(lib,&quot;User32.lib&quot;)<br />#pragma&nbsp;comment(lib,&quot;Advapi32.lib&quot;)<br />HANDLE&nbsp;hServiceThread;<br />void&nbsp;KillService();<br />char*&nbsp;strServiceName&nbsp;=&nbsp;&quot;sev_supcon&quot;;<br />SERVICE_STATUS_HANDLE&nbsp;nServiceStatusHandle;<br />HANDLE&nbsp;killServiceEvent;<br />BOOL&nbsp;nServiceRunning;<br />DWORD&nbsp;nServiceCurrentStatus;<br /><br /><br />DWORD&nbsp;mycode(LPDWORD&nbsp;param)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;//int&nbsp;result&nbsp;=&nbsp;MessageBox(NULL,&nbsp;TEXT(&quot;exeServer&quot;),&nbsp;NULL,&nbsp;MB_ICONINFORMATION&nbsp;|&nbsp;MB_YESNO);<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFile(L&quot;C:\\test\\exeServer.txt&quot;,&nbsp;GENERIC_WRITE,&nbsp;FILE_SHARE_WRITE&nbsp;|&nbsp;FILE_SHARE_READ,&nbsp;NULL,&nbsp;CREATE_ALWAYS,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hFile&nbsp;!=&nbsp;INVALID_HANDLE_VALUE)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;szSvcName&nbsp;=&nbsp;&quot;exeServer&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;nTemp&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteFile(hFile,&nbsp;szSvcName,&nbsp;strlen(szSvcName),&nbsp;&amp;nTemp,&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hFile);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />}<br />BOOL&nbsp;InitThread()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;id;<br />&nbsp;&nbsp;&nbsp;&nbsp;hServiceThread&nbsp;=&nbsp;CreateThread(0,&nbsp;0,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LPTHREAD_START_ROUTINE)mycode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;0,&nbsp;&amp;id);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hServiceThread&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nServiceRunning&nbsp;=&nbsp;true;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />BOOL&nbsp;ReportStatusToSCMgr(DWORD&nbsp;dwCurrentState,&nbsp;DWORD&nbsp;dwWin32ExitCode,&nbsp;DWORD&nbsp;dwServiceSpecificExitCode,&nbsp;DWORD&nbsp;dwCheckPoint,&nbsp;DWORD&nbsp;dwWaitHint)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;success;<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_STATUS&nbsp;nServiceStatus;<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwServiceType&nbsp;=&nbsp;SERVICE_WIN32_OWN_PROCESS;<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwCurrentState&nbsp;=&nbsp;dwCurrentState;<br />&nbsp;&nbsp;&nbsp;&nbsp;//<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(dwCurrentState&nbsp;==&nbsp;SERVICE_START_PENDING)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwControlsAccepted&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwControlsAccepted&nbsp;=&nbsp;SERVICE_ACCEPT_STOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;SERVICE_ACCEPT_SHUTDOWN;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(dwServiceSpecificExitCode&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwWin32ExitCode&nbsp;=&nbsp;dwWin32ExitCode;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwWin32ExitCode&nbsp;=&nbsp;ERROR_SERVICE_SPECIFIC_ERROR;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwServiceSpecificExitCode&nbsp;=&nbsp;dwServiceSpecificExitCode;<br />&nbsp;&nbsp;&nbsp;&nbsp;//<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwCheckPoint&nbsp;=&nbsp;dwCheckPoint;<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatus.dwWaitHint&nbsp;=&nbsp;dwWaitHint;<br />&nbsp;&nbsp;&nbsp;&nbsp;success&nbsp;=&nbsp;SetServiceStatus(nServiceStatusHandle,&nbsp;&amp;nServiceStatus);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!success)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KillService();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;success;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;success;<br />}<br /><br />void&nbsp;ServiceCtrlHandler(DWORD&nbsp;dwControlCode)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;success;<br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(dwControlCode)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_SHUTDOWN:<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_STOP:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nServiceCurrentStatus&nbsp;=&nbsp;SERVICE_STOP_PENDING;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;success&nbsp;=&nbsp;ReportStatusToSCMgr(SERVICE_STOP_PENDING,&nbsp;NO_ERROR,&nbsp;0,&nbsp;1,&nbsp;3000);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KillService();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br />&nbsp;&nbsp;&nbsp;&nbsp;default:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;ReportStatusToSCMgr(nServiceCurrentStatus,&nbsp;NO_ERROR,&nbsp;0,&nbsp;0,&nbsp;0);<br />}<br />void&nbsp;ServiceMain(DWORD&nbsp;argc,&nbsp;LPTSTR*&nbsp;argv)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;success;<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceStatusHandle&nbsp;=&nbsp;RegisterServiceCtrlHandlerA(strServiceName,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LPHANDLER_FUNCTION)ServiceCtrlHandler);<br />&nbsp;&nbsp;&nbsp;&nbsp;success&nbsp;=&nbsp;ReportStatusToSCMgr(SERVICE_START_PENDING,&nbsp;NO_ERROR,&nbsp;0,&nbsp;1,&nbsp;3000);<br />&nbsp;&nbsp;&nbsp;&nbsp;killServiceEvent&nbsp;=&nbsp;CreateEvent(0,&nbsp;TRUE,&nbsp;FALSE,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(killServiceEvent&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;success&nbsp;=&nbsp;ReportStatusToSCMgr(SERVICE_START_PENDING,&nbsp;NO_ERROR,&nbsp;0,&nbsp;2,&nbsp;1000);<br />&nbsp;&nbsp;&nbsp;&nbsp;success&nbsp;=&nbsp;InitThread();<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceCurrentStatus&nbsp;=&nbsp;SERVICE_RUNNING;<br />&nbsp;&nbsp;&nbsp;&nbsp;success&nbsp;=&nbsp;ReportStatusToSCMgr(SERVICE_RUNNING,&nbsp;NO_ERROR,&nbsp;0,&nbsp;0,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;WaitForSingleObject(killServiceEvent,&nbsp;INFINITE);<br />&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(killServiceEvent);<br />}<br /><br />void&nbsp;KillService()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;nServiceRunning&nbsp;=&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;SetEvent(killServiceEvent);<br />&nbsp;&nbsp;&nbsp;&nbsp;ReportStatusToSCMgr(SERVICE_STOPPED,&nbsp;NO_ERROR,&nbsp;0,&nbsp;0,&nbsp;0);<br />}<br /><br />void&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_TABLE_ENTRYA&nbsp;ServiceTable[]&nbsp;=<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;strServiceName,(LPSERVICE_MAIN_FUNCTIONA)ServiceMain&nbsp;},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;NULL,NULL&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;success;<br />&nbsp;&nbsp;&nbsp;&nbsp;success&nbsp;=&nbsp;StartServiceCtrlDispatcherA(ServiceTable);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!success)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;fialed!&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /></div></div><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>