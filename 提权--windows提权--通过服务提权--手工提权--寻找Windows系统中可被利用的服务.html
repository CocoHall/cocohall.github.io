<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>寻找Windows系统中可被利用的服务</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>寻找Windows系统中可被利用的服务</h1><br/>枚举Windows系统服务对应可执行文件的路径<br />如果路径包含普通用户的写权限，那么该服务可被用来提升权限<br /><br /><br />powershell代码<br /><div class="codebox"><div class="codebox">function&nbsp;Get-CurrentGroup(){<br />&nbsp;&nbsp;&nbsp;&nbsp;$User=[System.Security.Principal.WindowsIdentity]::GetCurrent()<br />&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$User.Groups.Value<br />&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;+=&nbsp;$User.user.value<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result<br />}<br /><br />function&nbsp;Is-Writable($path){<br />&nbsp;&nbsp;&nbsp;&nbsp;$flag=0<br />&nbsp;&nbsp;&nbsp;&nbsp;$group&nbsp;=&nbsp;Get-CurrentGroup<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;(Get-Acl&nbsp;-Path&nbsp;$path).Access&nbsp;|&nbsp;foreach{&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_.AccessControlType&nbsp;-eq&nbsp;&quot;Allow&quot;){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	$sid&nbsp;=&nbsp;(New-Object&nbsp;System.Security.Principal.NTAccount($_.IdentityReference.value)).Translate([System.Security.Principal.SecurityIdentifier]).value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;$sid&nbsp;-in&nbsp;$group&nbsp;){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(($_.FileSystemRights&nbsp;-eq&nbsp;2032127)&nbsp;-or&nbsp;($_.FileSystemRights&nbsp;-eq&nbsp;1048854)&nbsp;-or&nbsp;($_.FileSystemRights&nbsp;-eq&nbsp;1245631)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flag=1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$flag<br />}<br /><br />function&nbsp;Get-DirPath($path){<br />	$path&nbsp;=&nbsp;$path&nbsp;-replace&nbsp;&quot;^&nbsp;+&quot;,&quot;&quot;<br />	$path&nbsp;=&nbsp;$path&nbsp;-replace&nbsp;&quot;&nbsp;+$&quot;,&quot;&quot;<br />	$result&nbsp;=&nbsp;&quot;&quot;<br />	if($path.IndexOfAny(&#39;&quot;&#39;)&nbsp;-ne&nbsp;-1){<br />		if($path.IndexOfAny(&#39;&nbsp;&#39;)&nbsp;-ne&nbsp;-1){#有引号，有空格<br />			if($path.IndexOfAny(&#39;&nbsp;&#39;)&nbsp;-lt&nbsp;$path.IndexOfAny(&#39;&quot;&#39;)){#引号在后面的参数那<br />				$result&nbsp;=&nbsp;$path.SubString(0,$path.IndexOfAny(&#39;&nbsp;&#39;))<br />			}else{#前两个引号之间的是路径<br />				$result&nbsp;=&nbsp;$path.SubString($path.IndexOfAny(&#39;&quot;&#39;)+1)<br />				$result&nbsp;=&nbsp;$result.SubString(0,$result.IndexOfAny(&#39;&quot;&#39;))<br />			}<br />		}else{#有引号，没空格<br />			$result&nbsp;=&nbsp;$path.SubString($path.IndexOfAny(&#39;&quot;&#39;)+1,$path.LastIndexOfAny(&#39;&quot;&#39;)-1)<br />		}<br />	}else{<br />		if($path.IndexOfAny(&#39;&nbsp;&#39;)&nbsp;-ne&nbsp;-1){#没有引号有空格，<br />			if($path.LastIndexOfAny(&#39;\&#39;)&nbsp;-gt&nbsp;$path.LastIndexOfAny(&#39;&nbsp;&#39;)){#不规范的写法<br />				$result&nbsp;=&nbsp;$path<br />			}else{#空格是参数的分界<br />				$result&nbsp;=&nbsp;$path.SubString(0,$path.IndexOfAny(&#39;&nbsp;&#39;))<br />			}<br />			<br />		}else{#没有引号没有空格<br />			$result&nbsp;=&nbsp;$path<br />		}<br />	}<br />	return&nbsp;$result#.SubString(0,$result.LastIndexOfAny(&#39;\&#39;))<br />}<br />$ErrorActionPreference=&quot;SilentlyContinue&quot;<br /><br />$out&nbsp;=&nbsp;Get-WmiObject&nbsp;win32_service&nbsp;<br />for($i=0;$i&nbsp;-le&nbsp;$out.Count-1;$i++)<br />{<br />	$p=Get-DirPath($out[$i].PathName)<br />	if(Is-Writable($p)&nbsp;-eq&nbsp;1){<br />		Write-Host&nbsp;$out[$i].Name,$out[$i].PathName<br />	}<br />}<br /><br />Get-ChildItem&nbsp;&nbsp;-Path&nbsp;&quot;Registry::HKLM\SYSTEM\CurrentControlSet\Services&quot;&nbsp;|&nbsp;select&nbsp;name&nbsp;|&nbsp;foreach{<br />	$keyPath&nbsp;=&nbsp;&quot;Registry::&quot;+$_.name+&quot;\Parameters&quot;<br />	if(Test-Path($keyPath)){<br />		$dllpath&nbsp;=&nbsp;(Get-ItemProperty&nbsp;&nbsp;-path&nbsp;$keyPath).ServiceDll<br />		if(Is-Writable($p)&nbsp;&nbsp;-eq&nbsp;1){<br />			Write-Host&nbsp;$dllpath<br />		}<br />	}<br />}</div></div><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>