<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>dll系统服务</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>dll系统服务</h1><br/>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services<br />1. 在Services子健下新建项supcon。<br />2. 在supcon新建所需键值,键值说明如下：<br />(1) Description                 服务描述<br />(2) DisplayName             服务显示名<br />(3) ErrorControl                当该启动服务失败时产生错误的严重程度以及采取的保护措施，这里我们填 1 表示服务启动程序将把该错误记录到事件日志中并返回继续执行<br />(4) ImagePath                   程序的路径 我们要启动的是svchost.exe所以填入，<strong>%systemRoot%\system32\svchost.exe -k netsvcs</strong>，表示这个服务是属于netsvcs服务组<br />(5) ObjectName                 指定服务帐号 LocalSystem表示本地登录<br />(6)Start                             服务启动选项，填入2表示系统启动时由服务控制管理器自动启动该服务程序<br />(7)Type                             服务类型，填入0x10表示运行于独立进程的服务程序<br /><br />3. 在项supcon下再建一个子项Parameters。<br />4. 在Parameters新建键值ServiceDll，ServiceDll表示服务所对应dll所在的全路径<br />5. HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost 下，<br />修改键值netsvcs，添加supcon。<br />netsvcs里面的值就是svchost的服务组netsvcs所启动的所有服务<br /><br /><br /><a href=""><img src="images\557-1.png" alt="images\557-1.png" /></a><br /><br /><a href=""><img src="images\557-2.png" alt="images\557-2.png" /></a><br /><br /><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&quot;stdafx.h&quot;<br />#include&nbsp;&lt;stdlib.h&gt;<br />#include&lt;windows.h&gt;<br />DWORD&nbsp;g_dwServiceType;<br />SERVICE_STATUS_HANDLE&nbsp;g_hServiceStatus;<br />DWORD&nbsp;g_dwCurrState;<br /><br />char*&nbsp;szSvcName=&quot;dllserver&quot;;<br /><br />BOOL&nbsp;APIENTRY&nbsp;DllMain(HANDLE&nbsp;hModule,&nbsp;DWORD&nbsp;ul_reason_for_call,&nbsp;LPVOID&nbsp;lpReserved)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br />}<br /><br />int&nbsp;TellSCM(DWORD&nbsp;dwState,&nbsp;DWORD&nbsp;dwExitCode,&nbsp;DWORD&nbsp;dwProgress)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_STATUS&nbsp;srvStatus;<br />&nbsp;&nbsp;&nbsp;&nbsp;srvStatus.dwServiceType&nbsp;=&nbsp;SERVICE_WIN32_SHARE_PROCESS;<br />&nbsp;&nbsp;&nbsp;&nbsp;srvStatus.dwCurrentState&nbsp;=&nbsp;g_dwCurrState&nbsp;=&nbsp;dwState;<br />&nbsp;&nbsp;&nbsp;&nbsp;srvStatus.dwControlsAccepted&nbsp;=&nbsp;SERVICE_ACCEPT_STOP&nbsp;|&nbsp;SERVICE_ACCEPT_SHUTDOWN;<br />&nbsp;&nbsp;&nbsp;&nbsp;srvStatus.dwWin32ExitCode&nbsp;=&nbsp;dwExitCode;<br />&nbsp;&nbsp;&nbsp;&nbsp;srvStatus.dwServiceSpecificExitCode&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;srvStatus.dwCheckPoint&nbsp;=&nbsp;dwProgress;<br />&nbsp;&nbsp;&nbsp;&nbsp;srvStatus.dwWaitHint&nbsp;=&nbsp;1000;<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SetServiceStatus(g_hServiceStatus,&nbsp;&amp;srvStatus);<br />}<br /><br />void&nbsp;__stdcall&nbsp;ServiceHandler(DWORD&nbsp;dwControl)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(dwControl)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_STOP:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_STOP_PENDING,&nbsp;0,&nbsp;1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(10);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_STOPPED,&nbsp;0,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_PAUSE:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_PAUSE_PENDING,&nbsp;0,&nbsp;1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_PAUSED,&nbsp;0,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_CONTINUE:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_CONTINUE_PENDING,&nbsp;0,&nbsp;1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_RUNNING,&nbsp;0,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_INTERROGATE:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(g_dwCurrState,&nbsp;0,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />extern&nbsp;&quot;C&quot;&nbsp;__declspec(dllexport)&nbsp;void&nbsp;ServiceMain(int&nbsp;argc,&nbsp;wchar_t*&nbsp;argv[])<br />{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;注册一个服务控制程序<br />&nbsp;&nbsp;&nbsp;&nbsp;g_hServiceStatus&nbsp;=&nbsp;RegisterServiceCtrlHandler(szSvcName,&nbsp;(LPHANDLER_FUNCTION)ServiceHandler);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(g_hServiceStatus&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;FreeConsole();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_START_PENDING,&nbsp;0,&nbsp;1);&nbsp;//&nbsp;通知服务控制管理器该服务开始<br />&nbsp;&nbsp;&nbsp;&nbsp;TellSCM(SERVICE_RUNNING,&nbsp;0,&nbsp;0);&nbsp;&nbsp;//&nbsp;通知服务控制管理器该服务运行<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;在D盘创建一个txt创建并写入服务名作为测试<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFile(&quot;C:\\test\\dllserver.txt&quot;,&nbsp;GENERIC_WRITE,&nbsp;FILE_SHARE_WRITE&nbsp;|&nbsp;FILE_SHARE_READ,&nbsp;NULL,&nbsp;CREATE_ALWAYS,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hFile&nbsp;!=&nbsp;INVALID_HANDLE_VALUE)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;nTemp&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteFile(hFile,&nbsp;szSvcName,&nbsp;strlen(szSvcName),&nbsp;&amp;nTemp,&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hFile);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(100);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(g_dwCurrState&nbsp;!=&nbsp;SERVICE_STOP_PENDING&nbsp;&amp;&amp;&nbsp;g_dwCurrState&nbsp;!=&nbsp;SERVICE_STOPPED);<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />}<br /></div></div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>