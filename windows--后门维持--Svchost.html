<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Svchost</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Svchost</h1><br/>服务劫持部分的代码可以创建exe服务<br /><br />服务也可以是dll的形式，通过svchost启动<br /><br />svchost运行dll服务会将服务分组，默认组名如下：<br />    Local Service<br />    Local Service No Network<br />    Local Service Network Restricted<br />    Local System<br />    Local System Network Restricted<br />    Network Service<br />    <br />如下的代码演示了如何添加一个利用 Svchost 启动的 DLL 共享服务<br />需要注册<br /><br /><div class="codebox"><div class="codebox">BOOL&nbsp;search_svchost_service_name(TCHAR*&nbsp;service_name_buffer,&nbsp;PDWORD&nbsp;buffer_size)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;bRet&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;rc&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;HKEY&nbsp;hkRoot;<br />&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;buff[2048];<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR*&nbsp;ptr&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;type;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;size&nbsp;=&nbsp;sizeof(buff);<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;bExist&nbsp;=&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR&nbsp;tmp_service_name[50];<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR*&nbsp;pSvchost&nbsp;=&nbsp;_TEXT(&quot;SOFTWARE\\Microsoft\\Windows&nbsp;NT\\CurrentVersion\\Svchost&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegOpenKeyEx(HKEY_LOCAL_MACHINE,&nbsp;pSvchost,&nbsp;0,&nbsp;KEY_ALL_ACCESS,&nbsp;&amp;hkRoot);<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegQueryValueEx(hkRoot,&nbsp;_TEXT(&quot;netsvcs&quot;),&nbsp;0,&nbsp;&amp;type,&nbsp;buff,&nbsp;&amp;size);<br />&nbsp;&nbsp;&nbsp;&nbsp;SetLastError(rc);<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RegCloseKey(hkRoot);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;do<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wsprintf(tmp_service_name,&nbsp;_TEXT(&quot;netsvcs_0x%d&quot;),&nbsp;i);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(ptr&nbsp;=&nbsp;(TCHAR*)buff;&nbsp;*ptr;&nbsp;ptr&nbsp;=&nbsp;_tcschr(ptr,&nbsp;0)+1)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(lstrcmpi(ptr,&nbsp;tmp_service_name)&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;bExist&nbsp;=&nbsp;true;<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(bExist&nbsp;==&nbsp;false)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;bExist&nbsp;=&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;i++;<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;memcpy(buff&nbsp;+&nbsp;size&nbsp;-&nbsp;sizeof(TCHAR),&nbsp;tmp_service_name,&nbsp;lstrlen(tmp_service_name)&nbsp;*&nbsp;sizeof(TCHAR)&nbsp;+&nbsp;sizeof(TCHAR));<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegSetValueEx(hkRoot,&nbsp;_TEXT(&quot;netsvcs&quot;),&nbsp;0,&nbsp;REG_MULTI_SZ,&nbsp;buff,&nbsp;size&nbsp;+&nbsp;lstrlen(tmp_service_name)&nbsp;*&nbsp;sizeof(TCHAR)&nbsp;+&nbsp;sizeof(TCHAR));<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROE_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(bExist&nbsp;==&nbsp;false)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;lstrcpyn(service_name_buffer,&nbsp;tmp_service_name,&nbsp;*buffer_size);<br />&nbsp;&nbsp;&nbsp;&nbsp;*buffer_size&nbsp;=lstrlen(service_name_buffer);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;bRet&nbsp;=&nbsp;TRUE;<br />&nbsp;&nbsp;&nbsp;&nbsp;ERROE_EXIT:<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hkRoot&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;RegCloseKey(hkRoot);<br />&nbsp;&nbsp;&nbsp;&nbsp;hkRoot&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bRet;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;install_service(LPCTSTR&nbsp;full_dll_path,&nbsp;TCHAR*&nbsp;service_name_buffer,&nbsp;PDWORD&nbsp;buffer_size)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;bRet&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;rc&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;HKEY&nbsp;hkRoot&nbsp;=&nbsp;HKEY_LOCAL_MACHINE;<br />&nbsp;&nbsp;&nbsp;&nbsp;HKEY&nbsp;hkParam&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;hscm&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;schService&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR&nbsp;&nbsp;&nbsp;strModulePath[MAX_PATH];<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR&nbsp;&nbsp;strSysDir[MAX_PATH];<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;dwStartType&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;buff[1024];<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;type;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;size&nbsp;=&nbsp;sizeof(buff);<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR*&nbsp;binary_path&nbsp;=&nbsp;_TEXT(&quot;%SystemRoot%\\System32\\svchost.exe&nbsp;-k&nbsp;netsvcs&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR*&nbsp;ptr;<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR*&nbsp;pSvchost&nbsp;=&nbsp;_TEXT(&quot;SOFTWARE\\Microsoft\\Windows&nbsp;NT\\CurrentVersion\\Svchost&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegOpenKeyEx(hkRoot,&nbsp;pSvchost,&nbsp;0,&nbsp;KEY_QUERY_VALUE,&nbsp;&amp;hkRoot);<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegQueryValueEx(hkRoot,&nbsp;_TEXT(&quot;netsvcs&quot;),&nbsp;0,&nbsp;&amp;type,&nbsp;buff,&nbsp;&amp;size);<br />&nbsp;&nbsp;&nbsp;&nbsp;RegCloseKey(hkRoot);<br />&nbsp;&nbsp;&nbsp;&nbsp;SetLastError(rc);<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;//install&nbsp;service<br />&nbsp;&nbsp;&nbsp;&nbsp;hscm&nbsp;=&nbsp;OpenSCManager(NULL,&nbsp;NULL,&nbsp;SC_MANAGER_ALL_ACCESS);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hscm&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if(!search_svchost_service_name(service_name_buffer,&nbsp;buffer_size))<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;schService&nbsp;=&nbsp;CreateService(<br />&nbsp;&nbsp;&nbsp;&nbsp;hscm,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;SCManager&nbsp;database<br />&nbsp;&nbsp;&nbsp;&nbsp;service_name_buffer,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;name&nbsp;of&nbsp;service<br />&nbsp;&nbsp;&nbsp;&nbsp;service_name_buffer,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;service&nbsp;name&nbsp;to&nbsp;display<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;desired&nbsp;access<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_WIN32_OWN_PROCESS,<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_AUTO_START,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;start&nbsp;type<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ERROR_NORMAL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;error&nbsp;control&nbsp;type<br />&nbsp;&nbsp;&nbsp;&nbsp;binary_path,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;service&#39;s&nbsp;binary<br />&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;no&nbsp;load&nbsp;ordering&nbsp;group<br />&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;no&nbsp;tag&nbsp;identifier<br />&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;no&nbsp;dependencies<br />&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;LocalSystem&nbsp;account<br />&nbsp;&nbsp;&nbsp;&nbsp;NULL);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;no&nbsp;password<br />&nbsp;&nbsp;&nbsp;&nbsp;dwStartType&nbsp;=&nbsp;SERVICE_WIN32_OWN_PROCESS;<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(schService&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle(schService);<br />&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle(hscm);<br />&nbsp;&nbsp;&nbsp;&nbsp;//config&nbsp;service<br />&nbsp;&nbsp;&nbsp;&nbsp;hkRoot&nbsp;=&nbsp;HKEY_LOCAL_MACHINE;<br />&nbsp;&nbsp;&nbsp;&nbsp;lstrcpy((TCHAR*)buff,&nbsp;_TEXT(&quot;SYSTEM\\CurrentControlSet\\Services\\&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;lstrcat((TCHAR*)buff,&nbsp;service_name_buffer);<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegOpenKeyEx(hkRoot,&nbsp;(TCHAR*)buff,&nbsp;0,&nbsp;KEY_ALL_ACCESS,&nbsp;&amp;hkRoot);<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegCreateKey(hkRoot,&nbsp;_TEXT(&quot;Parameters&quot;),&nbsp;&amp;hkParam);<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;RegSetValueEx(hkParam,&nbsp;_TEXT(&quot;ServiceDll&quot;),&nbsp;0,&nbsp;REG_EXPAND_SZ,&nbsp;(PBYTE)full_dll_path,&nbsp;lstrlen(full_dll_path)&nbsp;&nbsp;*&nbsp;sizeof(TCHAR)&nbsp;+&nbsp;sizeof(TCHAR));<br />&nbsp;&nbsp;&nbsp;&nbsp;if(ERROR_SUCCESS&nbsp;!=&nbsp;rc)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;ERROR_EXIT;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;bRet&nbsp;=&nbsp;TRUE;<br />&nbsp;&nbsp;&nbsp;&nbsp;ERROR_EXIT:<br />&nbsp;&nbsp;&nbsp;&nbsp;if(hkParam&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;RegCloseKey(hkParam);<br />&nbsp;&nbsp;&nbsp;&nbsp;hkParam&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if(schService&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle(schService);<br />&nbsp;&nbsp;&nbsp;&nbsp;schService&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if(hscm&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle(hscm);<br />&nbsp;&nbsp;&nbsp;&nbsp;hscm&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bRet;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;start_service(LPCTSTR&nbsp;lpService)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;hSCManager&nbsp;=&nbsp;OpenSCManager(&nbsp;NULL,&nbsp;NULL,SC_MANAGER_CREATE_SERVICE&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;NULL&nbsp;!=&nbsp;hSCManager&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;hService&nbsp;=&nbsp;OpenService(hSCManager,&nbsp;lpService,&nbsp;DELETE&nbsp;|&nbsp;SERVICE_START);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;NULL&nbsp;!=&nbsp;hService&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;StartService(hService,&nbsp;0,&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle(&nbsp;hService&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle(&nbsp;hSCManager&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;add_to_service()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;//<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;bRet&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;service_name_size;<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR&nbsp;service_name[MAXBYTE&nbsp;*&nbsp;2];<br />&nbsp;&nbsp;&nbsp;&nbsp;service_name_size&nbsp;=&nbsp;sizeof(service_name)&nbsp;/&nbsp;sizeof(TCHAR);<br />&nbsp;&nbsp;&nbsp;&nbsp;if(install_service(_TEXT(&quot;C:\\service.dll&quot;),service_name,&nbsp;&amp;service_name_size))<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;start_service(service_name);<br />&nbsp;&nbsp;&nbsp;&nbsp;_tprintf(_TEXT(&quot;install&nbsp;service&nbsp;successful!!!&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;bRet=&nbsp;TRUE;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;_tprintf(_TEXT(&quot;can&nbsp;not&nbsp;install&nbsp;service!!!&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bRet;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />//而服务&nbsp;DLL&nbsp;也需要满足一定的格式，该服务必须导出&nbsp;ServiceMain()&nbsp;函数<br />//并调用&nbsp;RegisterServiceCtrlHandlerEx()&nbsp;函数注册&nbsp;Service&nbsp;Handler，具体的服务&nbsp;DLL&nbsp;的代码如下如下<br /><br />BOOL&nbsp;APIENTRY&nbsp;DllMain(&nbsp;HMODULE&nbsp;hModule,DWORD&nbsp;&nbsp;ul_reason_for_call,&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;lpReserved<br />&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(ul_reason_for_call)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_STATUS_HANDLE&nbsp;g_service_status_handle&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_STATUS&nbsp;g_service_status&nbsp;=<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_WIN32_SHARE_PROCESS,<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_START_PENDING,<br />&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ACCEPT_STOP&nbsp;|&nbsp;SERVICE_ACCEPT_SHUTDOWN&nbsp;|&nbsp;SERVICE_ACCEPT_PAUSE_CONTINUE<br />&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;WINAPI&nbsp;ServiceHandler(DWORD&nbsp;dwControl,DWORD&nbsp;dwEventType,LPVOID&nbsp;lpEventData,LPVOID&nbsp;lpContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(dwControl)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_STOP:<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_SHUTDOWN:<br />&nbsp;&nbsp;&nbsp;&nbsp;g_service_status.dwCurrentState&nbsp;=&nbsp;SERVICE_STOPPED;<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_PAUSE:<br />&nbsp;&nbsp;&nbsp;&nbsp;g_service_status.dwCurrentState&nbsp;=&nbsp;SERVICE_PAUSED;<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_CONTINUE:<br />&nbsp;&nbsp;&nbsp;&nbsp;g_service_status.dwCurrentState&nbsp;=&nbsp;SERVICE_RUNNING;<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;SERVICE_CONTROL_INTERROGATE:<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;default:<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;SetServiceStatus(g_service_status_handle,&nbsp;&amp;g_service_status);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NO_ERROR;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;extern&nbsp;&quot;C&quot;&nbsp;__declspec(dllexport)&nbsp;VOID&nbsp;WINAPI&nbsp;ServiceMain(DWORD&nbsp;dwArgc,LPCTSTR*&nbsp;lpszArgv)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;g_service_status_handle&nbsp;=&nbsp;RegisterServiceCtrlHandlerEx(_TEXT(&quot;Svchost&nbsp;Service&quot;),&nbsp;ServiceHandler,&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!g_service_status_handle)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;g_service_status.dwCurrentState&nbsp;=&nbsp;SERVICE_RUNNING;<br />&nbsp;&nbsp;&nbsp;&nbsp;SetServiceStatus(g_service_status_handle,&nbsp;&amp;g_service_status);<br />&nbsp;&nbsp;&nbsp;&nbsp;while(TRUE)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;Sleep(1000);<br />&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(_TEXT(&quot;Hello&nbsp;Topsec&nbsp;In&nbsp;Svchost&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />&nbsp;&nbsp;&nbsp;&nbsp;};</div></div><br /><br /><br /><br />参考：<a href="https://www.jianshu.com/p/aa27af7ac09f">https://www.jianshu.com/p/aa27af7ac09f</a><br />这个更完整<br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>